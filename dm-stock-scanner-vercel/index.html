<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f0f1a">
    <title>DM Stock Scanner</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <style>
        :root{--bg:#0f0f1a;--card:#1a1a2e;--border:#2d2d4a;--accent:#e94560;--accent-glow:rgba(233,69,96,0.15);--success:#4ade80;--success-glow:rgba(74,222,128,0.15);--warning:#fbbf24;--danger:#ef4444;--text:#eaeaea;--text-muted:#8892b0;--text-dim:#5a6078}
        *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
        html,body{height:100%;overflow:hidden}
        body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text)}
        .app{height:100%;display:flex;flex-direction:column}
        .header{flex-shrink:0;background:var(--card);border-bottom:1px solid var(--border);padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
        .header-left{display:flex;align-items:center;gap:10px}
        .back-btn{background:none;border:none;color:var(--text);font-size:20px;cursor:pointer;padding:8px;display:none;align-items:center;justify-content:center}
        .back-btn.visible{display:flex}
        .header-title{font-weight:600;font-size:17px}
        .header-user{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:6px 12px;font-size:13px;color:var(--text-muted);cursor:pointer}
        .content{flex:1;overflow-y:auto;padding:16px;padding-bottom:100px;-webkit-overflow-scrolling:touch}
        .screen{display:none}
        .screen.active{display:block}
        .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--card);border-top:1px solid var(--border);display:flex;padding:8px 0;padding-bottom:max(8px,env(safe-area-inset-bottom))}
        .nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px 4px;cursor:pointer;color:var(--text-muted);border:none;background:none;font-family:inherit}
        .nav-item.active{color:var(--accent)}
        .nav-icon{font-size:22px}
        .nav-label{font-size:10px;font-weight:500}
        .card{background:var(--card);border-radius:16px;padding:16px;margin-bottom:16px;border:1px solid var(--border)}
        .section-title{font-size:11px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-muted);margin-bottom:12px;font-weight:600}
        .quick-actions{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px}
        .quick-action{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:28px 16px;text-align:center;cursor:pointer;transition:transform 0.1s}
        .quick-action:active{transform:scale(0.97)}
        .quick-action-icon{font-size:36px;margin-bottom:10px}
        .quick-action-title{font-weight:600;font-size:16px;margin-bottom:4px}
        .quick-action-sub{font-size:12px;color:var(--text-muted)}
        .stats-row{display:flex;gap:12px;margin-bottom:20px}
        .stat-card{flex:1;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center}
        .stat-value{font-size:24px;font-weight:700;font-family:'JetBrains Mono',monospace}
        .stat-value.accent{color:var(--accent)}
        .stat-value.success{color:var(--success)}
        .stat-label{font-size:11px;color:var(--text-muted);margin-top:4px}
        .search-container{position:relative;margin-bottom:12px}
        .search-input{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:14px 16px 14px 44px;color:var(--text);font-size:15px;font-family:inherit;outline:none}
        .search-input:focus{border-color:var(--accent)}
        .search-input::placeholder{color:var(--text-dim)}
        .search-icon{position:absolute;left:16px;top:50%;transform:translateY(-50%);font-size:18px;color:var(--text-muted)}
        .filter-row{display:flex;gap:8px;overflow-x:auto;padding-bottom:8px;margin-bottom:12px;-webkit-overflow-scrolling:touch}
        .filter-pill{padding:8px 14px;border-radius:20px;border:none;cursor:pointer;font-size:12px;font-weight:500;font-family:inherit;white-space:nowrap;background:var(--bg);color:var(--text-muted)}
        .filter-pill.active{background:var(--accent);color:white}
        .results-count{font-size:12px;color:var(--text-muted);margin-bottom:12px}
        .product-list{display:flex;flex-direction:column;gap:8px}
        .product-item{background:var(--card);border-radius:12px;padding:14px;display:flex;align-items:center;gap:12px;cursor:pointer;border:1px solid var(--border)}
        .product-item:active{background:var(--border)}
        .product-icon{width:44px;height:44px;background:var(--bg);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;overflow:hidden}
        .product-icon img{width:100%;height:100%;object-fit:cover}
        .product-info{flex:1;min-width:0}
        .product-name{font-size:14px;font-weight:600;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .product-meta{font-size:12px;color:var(--text-muted);display:flex;gap:8px}
        .product-stock{font-weight:600;font-family:'JetBrains Mono',monospace;font-size:14px;min-width:32px;text-align:right}
        .product-stock.low{color:var(--accent)}
        .product-stock.ok{color:var(--success)}
        .scanner-box{background:var(--bg);border-radius:16px;aspect-ratio:4/3;display:flex;align-items:center;justify-content:center;margin-bottom:16px;overflow:hidden;position:relative;border:2px dashed var(--border)}
        .scanner-box.active{border-style:solid;border-color:var(--accent)}
        #scannerReader{width:100%;height:100%}
        #scannerReader video{width:100%!important;height:100%!important;object-fit:cover!important;border-radius:14px}
        #scannerReader img[alt="Info icon"]{display:none!important}
        #qr-shaded-region{border-radius:8px!important}
        .scanner-video{width:100%;height:100%;object-fit:cover}
        .scanner-overlay{position:absolute;width:70%;height:50%;border:2px solid var(--accent);border-radius:8px;box-shadow:0 0 0 9999px rgba(0,0,0,0.5)}
        .scanner-line{position:absolute;width:100%;height:2px;background:var(--accent);animation:scan 2s ease-in-out infinite}
        @keyframes scan{0%,100%{top:20%}50%{top:80%}}
        .scanner-placeholder{text-align:center;color:var(--text-muted)}
        .scanner-placeholder-icon{font-size:48px;margin-bottom:12px}
        .input-row{display:flex;gap:10px}
        .input-field{flex:1;background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:14px 16px;color:var(--text);font-size:15px;font-family:'JetBrains Mono',monospace;outline:none}
        .input-field:focus{border-color:var(--accent)}
        .input-field::placeholder{color:var(--text-dim);font-family:'Inter',sans-serif}
        .select-field{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:14px 16px;color:var(--text);font-size:15px;font-family:inherit;outline:none;appearance:none;cursor:pointer}
        .btn{padding:14px 20px;border-radius:12px;border:none;font-weight:600;cursor:pointer;font-size:14px;font-family:inherit;display:flex;align-items:center;justify-content:center;gap:8px;transition:transform 0.1s}
        .btn:active{transform:scale(0.97)}
        .btn-primary{background:var(--accent);color:white}
        .btn-secondary{background:var(--bg);color:var(--text);border:1px solid var(--border)}
        .btn-success{background:var(--success);color:#000}
        .btn-full{width:100%}
        .product-header{display:flex;gap:16px;margin-bottom:16px}
        .product-image{width:80px;height:80px;background:var(--bg);border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:32px;flex-shrink:0;overflow:hidden}
        .product-image img{width:100%;height:100%;object-fit:cover}
        .product-detail-name{font-size:18px;font-weight:700;margin-bottom:4px;line-height:1.3}
        .product-detail-category{font-size:13px;color:var(--accent);margin-bottom:4px}
        .product-detail-barcode{font-size:12px;color:var(--text-muted);font-family:'JetBrains Mono',monospace}
        .stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px}
        .stat-box{background:var(--bg);border-radius:10px;padding:12px;text-align:center}
        .stat-box-value{font-size:20px;font-weight:700;font-family:'JetBrains Mono',monospace}
        .stat-box-value.price{color:var(--success)}
        .stat-box-value.stock{color:var(--warning)}
        .stat-box-value.stock.low{color:var(--accent)}
        .stat-box-label{font-size:10px;color:var(--text-muted);text-transform:uppercase;margin-top:2px}
        .quantity-section{margin:16px 0}
        .quantity-control{display:flex;align-items:center;justify-content:center;gap:20px}
        .quantity-btn{width:52px;height:52px;border-radius:50%;background:var(--bg);border:1px solid var(--border);font-size:24px;cursor:pointer;color:var(--text);display:flex;align-items:center;justify-content:center}
        .quantity-btn:active{background:var(--border)}
        .quantity-value{font-size:32px;font-weight:700;font-family:'JetBrains Mono',monospace;min-width:60px;text-align:center}
        .quantity-unit{font-size:12px;color:var(--text-muted);text-align:center}
        .action-buttons{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px}
        .action-btn{padding:18px;border-radius:14px;border:none;font-weight:600;cursor:pointer;font-size:15px;font-family:inherit;display:flex;flex-direction:column;align-items:center;gap:6px}
        .action-btn.out{background:linear-gradient(135deg,var(--accent),#ff6b9d);color:white}
        .action-btn.in{background:linear-gradient(135deg,var(--success),#22d3ee);color:#000}
        .action-btn-icon{font-size:24px}
        .more-actions{margin-top:16px;padding-top:16px;border-top:1px solid var(--border)}
        .more-action-btn{display:flex;align-items:center;gap:12px;width:100%;padding:14px;background:none;border:none;color:var(--text);cursor:pointer;font-size:14px;font-family:inherit;border-radius:10px}
        .more-action-btn:active{background:var(--bg)}
        .more-action-icon{font-size:18px;width:24px;text-align:center}
        .history-item{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--border)}
        .history-item:last-child{border-bottom:none}
        .history-icon{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px}
        .history-icon.out{background:var(--accent-glow);color:var(--accent)}
        .history-icon.in{background:var(--success-glow);color:var(--success)}
        .history-info{flex:1}
        .history-name{font-size:13px;font-weight:500}
        .history-details{font-size:11px;color:var(--text-muted)}
        .history-amount{font-weight:600;font-family:'JetBrains Mono',monospace}
        .history-amount.out{color:var(--accent)}
        .history-amount.in{color:var(--success)}
        .log-card{background:var(--card);border-radius:12px;margin-bottom:12px;border:1px solid var(--border);overflow:hidden}
        .log-header{display:flex;align-items:center;padding:14px;cursor:pointer}
        .log-header:active{background:var(--bg)}
        .log-info{flex:1}
        .log-project{font-weight:600;font-size:14px}
        .log-meta{font-size:12px;color:var(--text-muted);margin-top:2px}
        .log-totals{text-align:right;margin-right:12px}
        .log-total-cost{font-size:12px;color:var(--text-muted)}
        .log-total-margin{font-size:14px;font-weight:600;color:var(--success)}
        .log-chevron{font-size:16px;color:var(--text-muted)}
        .log-details{display:none;padding:0 14px 14px;border-top:1px solid var(--border)}
        .log-details.visible{display:block}
        .log-item{display:flex;align-items:center;padding:10px 0;border-bottom:1px solid var(--border);gap:8px}
        .log-item:last-child{border-bottom:none}
        .log-item-name{flex:1;font-size:13px}
        .log-item-margin{display:flex;align-items:center;gap:4px}
        .log-item-margin input{width:50px;padding:6px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:12px;text-align:center}
        .log-item-totals{text-align:right;min-width:70px}
        .log-item-cost{font-size:11px;color:var(--text-muted)}
        .log-item-price{font-size:13px;font-weight:600;color:var(--success)}
        .form-group{margin-bottom:16px}
        .form-label{font-size:12px;color:var(--text-muted);margin-bottom:6px;display:block}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        .form-hint{font-size:11px;color:var(--text-dim);margin-top:4px}
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;padding:20px;z-index:100}
        .modal-overlay.visible{display:flex}
        .modal-content{background:var(--card);border-radius:20px;padding:24px;width:100%;max-width:400px;max-height:90vh;overflow-y:auto}
        .modal-title{font-size:18px;font-weight:700;margin-bottom:16px;text-align:center}
        .modal-buttons{display:flex;flex-direction:column;gap:10px;margin-top:20px}
        .toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--card);border:1px solid var(--border);padding:12px 20px;border-radius:12px;display:flex;align-items:center;gap:10px;opacity:0;transition:all 0.3s;z-index:200;pointer-events:none}
        .toast.visible{opacity:1;transform:translateX(-50%) translateY(0)}
        .toast.error{border-color:var(--accent)}
        .loading-overlay{position:fixed;inset:0;background:rgba(15,15,26,0.9);display:none;align-items:center;justify-content:center;z-index:300}
        .loading-overlay.visible{display:flex}
        .loading-spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .setup-screen{display:none;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:24px;text-align:center}
        .setup-logo{font-size:64px;margin-bottom:16px}
        .setup-title{font-size:24px;font-weight:700;margin-bottom:8px}
        .setup-subtitle{font-size:14px;color:var(--text-muted);margin-bottom:32px}
        .setup-card{background:var(--card);border-radius:20px;padding:24px;width:100%;max-width:360px}
        .empty-state{text-align:center;padding:40px 20px;color:var(--text-muted)}
        .empty-state-icon{font-size:48px;margin-bottom:12px;opacity:0.5}
        .link-banner{background:var(--accent);color:white;padding:12px 16px;border-radius:12px;margin-bottom:16px;display:flex;align-items:center;gap:12px}
        .link-banner-text{flex:1}
        .link-banner-title{font-weight:600;font-size:14px}
        .link-banner-code{font-size:12px;opacity:0.9;font-family:'JetBrains Mono',monospace}
        .link-banner-close{background:rgba(255,255,255,0.2);border:none;color:white;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:16px}
        /* Label format radio styling */
        input[name="labelFormat"]:checked+span+span+span{color:var(--text)}
        label:has(input[name="labelFormat"]:checked){border-color:var(--accent)!important}
        label:has(input[name="labelFormat"]:not(:checked)){border-color:var(--border)!important}
        /* Quagga viewport */
        #scannerViewport{position:relative;width:100%;height:100%}
        #scannerViewport video{width:100%;height:100%;object-fit:cover}
        #scannerViewport canvas{position:absolute;top:0;left:0;width:100%;height:100%}
        .drawingBuffer{display:none}
        /* Barcode confirmation */
        .barcode-confirm{background:var(--card);border-radius:16px;padding:20px;text-align:center;margin-top:16px;border:2px solid var(--success)}
        .barcode-confirm-label{font-size:12px;color:var(--text-muted);margin-bottom:8px}
        .barcode-confirm-value{font-size:28px;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--success);margin-bottom:16px;word-break:break-all}
        .barcode-confirm-buttons{display:flex;gap:12px}
        .barcode-confirm-buttons .btn{flex:1}
        .scan-status{text-align:center;padding:12px;font-size:13px;color:var(--text-muted)}
        .scan-status.detecting{color:var(--warning)}
        .scan-status.found{color:var(--success)}
        /* OCR Styles */
        .ocr-section{margin-top:16px;padding-top:16px;border-top:1px solid var(--border)}
        .ocr-btn{width:100%;padding:16px;background:var(--card);border:2px dashed var(--border);border-radius:12px;color:var(--text);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px}
        .ocr-btn:active{background:var(--bg)}
        .ocr-btn.processing{border-color:var(--warning);animation:pulse 1.5s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.6}}
        .ocr-results{margin-top:12px;background:var(--card);border-radius:12px;border:1px solid var(--border);overflow:hidden}
        .ocr-result-item{padding:12px 14px;border-bottom:1px solid var(--border);cursor:pointer;display:flex;align-items:center;gap:12px}
        .ocr-result-item:last-child{border-bottom:none}
        .ocr-result-item:active{background:var(--bg)}
        .ocr-result-match{font-size:10px;padding:3px 8px;border-radius:10px;background:var(--success);color:#000;font-weight:600}
        .ocr-result-partial{background:var(--warning)}
        .ocr-detected-text{background:var(--bg);padding:10px 14px;border-radius:8px;font-size:13px;margin-bottom:12px}
        .ocr-detected-label{font-size:11px;color:var(--text-muted);margin-bottom:4px}
    </style>
</head>
<body>
    <div class="app">
        <div class="toast" id="toast"><span id="toastIcon">‚úì</span><span id="toastMessage"></span></div>
        <div class="loading-overlay" id="loadingOverlay"><div class="loading-spinner"></div></div>
        
        <!-- Modals -->
        <div class="modal-overlay" id="orderModal">
            <div class="modal-content">
                <div class="modal-title">üìß Bijbestellen</div>
                <div id="orderProductInfo" style="background:var(--bg);padding:12px;border-radius:10px;font-size:13px;margin-bottom:16px"></div>
                <div class="form-group"><label class="form-label">Aantal</label><input type="number" class="input-field" id="orderQuantity" value="1"></div>
                <div class="form-group"><label class="form-label">Email</label><input type="email" class="input-field" id="orderEmail"></div>
                <div class="form-group"><label class="form-label">Opmerking</label><input type="text" class="input-field" id="orderNote"></div>
                <div class="modal-buttons">
                    <button class="btn btn-primary" onclick="sendOrderEmail()">üìß Verstuur</button>
                    <button class="btn btn-secondary" onclick="closeModal('orderModal')">Annuleren</button>
                </div>
            </div>
        </div>
        
        <div class="modal-overlay" id="linkModal">
            <div class="modal-content">
                <div class="modal-title">Barcode niet gevonden</div>
                <div style="text-align:center;margin-bottom:20px">
                    <div style="font-family:'JetBrains Mono',monospace;font-size:20px;color:var(--accent);margin-bottom:8px" id="linkModalBarcode"></div>
                </div>
                <div class="modal-buttons">
                    <button class="btn btn-primary" onclick="linkToExisting()">üîó Koppelen aan artikel</button>
                    <button class="btn btn-success" onclick="createNewFromBarcode()">‚ûï Nieuw artikel</button>
                    <button class="btn btn-secondary" onclick="closeModal('linkModal')">Annuleren</button>
                </div>
            </div>
        </div>
        
        <div class="modal-overlay" id="actionsModal">
            <div class="modal-content">
                <div class="modal-title">Meer acties</div>
                <button class="more-action-btn" onclick="closeModal('actionsModal');showPanel('edit')"><span class="more-action-icon">‚úèÔ∏è</span>Bewerken</button>
                <button class="more-action-btn" onclick="closeModal('actionsModal');showPanel('link')"><span class="more-action-icon">üîó</span>Barcode koppelen</button>
                <button class="more-action-btn" onclick="closeModal('actionsModal');showPanel('qr')"><span class="more-action-icon">üè∑Ô∏è</span>QR code</button>
                <button class="more-action-btn" onclick="closeModal('actionsModal');showPanel('photo')"><span class="more-action-icon">üì∏</span>Foto toevoegen</button>
                <button class="more-action-btn" onclick="closeModal('actionsModal');openOrderModal()"><span class="more-action-icon">üìß</span>Bijbestellen</button>
                <div class="modal-buttons"><button class="btn btn-secondary" onclick="closeModal('actionsModal')">Sluiten</button></div>
            </div>
        </div>

        <!-- Setup -->
        <div class="setup-screen" id="setupScreen">
            <div class="setup-logo">üì¶</div>
            <h1 class="setup-title">DM Stock Scanner</h1>
            <p class="setup-subtitle">Configureer de app om te beginnen</p>
            <div class="setup-card">
                <div class="form-group">
                    <label class="form-label">Notion API Key</label>
                    <input type="password" class="input-field" id="setupApiKey" placeholder="secret_...">
                </div>
                <button class="btn btn-primary btn-full" onclick="saveSetup()">üîó Verbinden</button>
            </div>
        </div>

        <!-- Main App -->
        <div id="mainApp" style="display:none;height:100%;flex-direction:column">
            <header class="header">
                <div class="header-left">
                    <button class="back-btn" id="backBtn" onclick="goBack()">‚Üê</button>
                    <span class="header-title" id="headerTitle">Stock Scanner</span>
                </div>
                <button class="header-user" id="headerUser" onclick="showScreen('more')">BAS ‚ñº</button>
            </header>

            <main class="content">
                <!-- HOME -->
                <div class="screen active" id="screenHome">
                    <div class="quick-actions">
                        <div class="quick-action" onclick="showScreen('scan')">
                            <div class="quick-action-icon">üì∑</div>
                            <div class="quick-action-title">Scannen</div>
                            <div class="quick-action-sub">Barcode camera</div>
                        </div>
                        <div class="quick-action" onclick="showScreen('articles')">
                            <div class="quick-action-icon">üìã</div>
                            <div class="quick-action-title">Bladeren</div>
                            <div class="quick-action-sub">Artikelen lijst</div>
                        </div>
                    </div>
                    <div class="stats-row">
                        <div class="stat-card"><div class="stat-value accent" id="statToday">0</div><div class="stat-label">Vandaag</div></div>
                        <div class="stat-card"><div class="stat-value success" id="statTotal">0</div><div class="stat-label">Artikelen</div></div>
                    </div>
                    <div class="card" id="favoritesCard" style="display:none">
                        <div class="section-title">‚≠ê Favorieten</div>
                        <div id="favoritesList"></div>
                    </div>
                    <div class="card">
                        <div class="section-title">üïê Recente activiteit</div>
                        <div id="historyList"><div class="empty-state"><div class="empty-state-icon">üïê</div><div>Nog geen activiteit</div></div></div>
                    </div>
                </div>

                <!-- SCAN -->
                <div class="screen" id="screenScan">
                    <div id="scannerBox" class="scanner-box">
                        <div id="scannerReader"></div>
                        <div class="scanner-placeholder" id="scannerPlaceholder" onclick="startScanner()">
                            <div class="scanner-placeholder-icon">üì∑</div>
                            <div>Tik om scanner te starten</div>
                        </div>
                    </div>
                    
                    <div class="scan-status" id="scanStatus">Camera niet actief</div>
                    
                    <!-- Barcode Confirmation -->
                    <div class="barcode-confirm" id="barcodeConfirm" style="display:none">
                        <div class="barcode-confirm-label">Gescande code:</div>
                        <div class="barcode-confirm-value" id="scannedBarcodeValue">-</div>
                        <div style="font-size:11px;color:var(--text-muted);margin-bottom:8px" id="scannedBarcodeFormat">-</div>
                        <div class="barcode-confirm-buttons">
                            <button class="btn btn-secondary" onclick="rejectScan()">‚úï Opnieuw</button>
                            <button class="btn btn-success" onclick="acceptScan()">‚úì Bevestig</button>
                        </div>
                    </div>
                    
                    <!-- Search Results -->
                    <div id="ocrResults"></div>
                    
                    <div style="margin-top:16px">
                        <div class="section-title">Of typ handmatig</div>
                        <div class="input-row">
                            <input type="text" class="input-field" id="barcodeInput" placeholder="Barcode of naam..." onkeypress="if(event.key==='Enter')lookupBarcode()">
                            <button class="btn btn-primary" onclick="lookupBarcode()">üîç</button>
                        </div>
                    </div>
                    
                    <!-- Extra ruimte voor mobiel scrollen -->
                    <div style="height:120px"></div>
                </div>

                <!-- ARTICLES -->
                <div class="screen" id="screenArticles">
                    <div id="linkBanner" style="display:none"></div>
                    <div class="search-container">
                        <span class="search-icon">üîç</span>
                        <input type="text" class="search-input" id="searchInput" placeholder="Zoek artikel..." oninput="filterProducts()">
                    </div>
                    <div class="filter-row" id="categoryPills"></div>
                    <div class="results-count" id="resultsCount">0 artikelen</div>
                    <div class="product-list" id="productList"></div>
                </div>

                <!-- PRODUCT -->
                <div class="screen" id="screenProduct">
                    <div class="card">
                        <div class="product-header">
                            <div class="product-image" id="productImage">üì¶</div>
                            <div style="flex:1">
                                <div class="product-detail-name" id="productName">-</div>
                                <div class="product-detail-category" id="productCategory">-</div>
                                <div class="product-detail-barcode" id="productBarcode">-</div>
                            </div>
                            <button class="btn btn-secondary" id="productFavoriteBtn" onclick="toggleCurrentFavorite()" style="padding:10px;font-size:18px">‚òÜ</button>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-box"><div class="stat-box-value price" id="productPrice">-</div><div class="stat-box-label">Prijs</div></div>
                            <div class="stat-box"><div class="stat-box-value stock" id="productStock">-</div><div class="stat-box-label">Stock</div></div>
                            <div class="stat-box"><div class="stat-box-value" id="productUnit">-</div><div class="stat-box-label">Eenheid</div></div>
                        </div>
                        <select class="select-field" id="projectSelect"><option value="">-- Project kiezen --</option></select>
                        <div class="quantity-section">
                            <div class="quantity-control">
                                <button class="quantity-btn" onclick="changeQuantity(-1)">‚àí</button>
                                <div><div class="quantity-value" id="quantityValue">1</div><div class="quantity-unit" id="quantityUnit">stuks</div></div>
                                <button class="quantity-btn" onclick="changeQuantity(1)">+</button>
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button class="action-btn out" onclick="registerAction('Uitscannen')"><span class="action-btn-icon">‚Üë</span>Uitscannen</button>
                            <button class="action-btn in" onclick="registerAction('Inleggen')"><span class="action-btn-icon">‚Üì</span>Inleggen</button>
                        </div>
                        <div class="more-actions">
                            <button class="more-action-btn" onclick="openModal('actionsModal')" style="justify-content:center;background:var(--bg)">‚Ä¢‚Ä¢‚Ä¢ Meer acties</button>
                        </div>
                    </div>
                    <div class="card" id="editPanel" style="display:none">
                        <div class="section-title">‚úèÔ∏è Bewerken</div>
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">Min. stock</label><input type="number" class="input-field" id="editMinStock"></div>
                            <div class="form-group"><label class="form-label">Ideale stock</label><input type="number" class="input-field" id="editIdealStock"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Stock correctie</label>
                            <div style="font-size:12px;color:var(--text-muted);margin-bottom:8px">Huidige stock: <span id="currentStockValue">0</span></div>
                            <div class="input-row"><input type="number" class="input-field" id="editStockValue" placeholder="Nieuwe waarde"><button class="btn btn-primary" onclick="saveStockCorrection()">üíæ</button></div>
                            <div style="font-size:11px;color:var(--text-muted);margin-top:4px">Verschil wordt als registratie opgeslagen</div>
                        </div>
                        <button class="btn btn-secondary btn-full" onclick="saveProductEdits()">Opslaan & sluiten</button>
                    </div>
                    <div class="card" id="linkPanel" style="display:none">
                        <div class="section-title">üîó Barcode Koppelen</div>
                        <div style="font-size:12px;color:var(--text-muted);margin-bottom:12px">Huidige: <span id="currentBarcode">-</span></div>
                        <div class="input-row">
                            <input type="text" class="input-field" id="linkBarcodeInput" placeholder="Nieuwe barcode...">
                            <button class="btn btn-secondary" onclick="scanForLink()">üì∑</button>
                            <button class="btn btn-primary" onclick="saveLinkedBarcode()">üíæ</button>
                        </div>
                    </div>
                    <div class="card" id="photoPanel" style="display:none">
                        <div class="section-title">üì∏ Product Foto</div>
                        <div style="aspect-ratio:1;background:var(--bg);border-radius:12px;display:flex;align-items:center;justify-content:center;overflow:hidden;margin-bottom:12px;border:2px dashed var(--border)" id="photoCaptureBox" onclick="startPhotoCapture()">
                            <video id="photoVideo" style="display:none;width:100%;height:100%;object-fit:cover" autoplay playsinline></video>
                            <img id="photoPreview" style="display:none;width:100%;height:100%;object-fit:cover">
                            <div id="photoPlaceholder" style="text-align:center;color:var(--text-muted)"><div style="font-size:40px;margin-bottom:8px">üì∏</div><div>Tik om foto te maken</div></div>
                        </div>
                        <div class="input-row" id="photoActions" style="display:none">
                            <button class="btn btn-secondary" onclick="retakePhoto()" style="flex:1">üîÑ Opnieuw</button>
                            <button class="btn btn-primary" onclick="savePhoto()" style="flex:1">üíæ Opslaan</button>
                        </div>
                    </div>
                    <div class="card" id="qrPanel" style="display:none">
                        <div class="section-title">üè∑Ô∏è QR Code</div>
                        <div style="display:flex;gap:16px;align-items:flex-start">
                            <div id="qrPreviewBox" style="width:120px;height:120px;background:var(--bg);border-radius:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0">
                                <canvas id="qrPreviewCanvas" style="width:100px;height:100px"></canvas>
                            </div>
                            <div style="flex:1">
                                <div style="font-size:12px;color:var(--text-muted);margin-bottom:4px">Huidige code:</div>
                                <div id="qrCurrentCode" style="font-family:'JetBrains Mono',monospace;font-size:16px;font-weight:600;margin-bottom:12px">-</div>
                                <div style="font-size:11px;color:var(--text-muted)">
                                    <div id="qrHasDMCode" style="display:none;color:var(--success)">‚úì DM code toegewezen</div>
                                    <div id="qrNoDMCode" style="display:none;color:var(--warning)">‚ö† Geen DM code</div>
                                </div>
                            </div>
                        </div>
                        <div style="display:flex;gap:8px;margin-top:16px;flex-wrap:wrap">
                            <button class="btn btn-secondary" onclick="generateProductQR()" id="qrGenerateBtn" style="flex:1;min-width:100px">üîÑ Genereer DM Code</button>
                            <button class="btn btn-success" onclick="printProductQR()" id="qrPrintBtn" style="flex:1;min-width:100px">üñ®Ô∏è Print</button>
                        </div>
                    </div>
                    
                    <!-- Extra ruimte voor mobiel scrollen -->
                    <div style="height:120px"></div>
                </div>

                <!-- LOG -->
                <div class="screen" id="screenLog">
                    <div class="section-title">üìä Project Overzicht</div>
                    <div id="logList"><div class="empty-state"><div class="empty-state-icon">üìä</div><div>Nog geen registraties</div></div></div>
                    <button class="btn btn-secondary btn-full" onclick="clearScanLog()" style="margin-top:16px;opacity:0.6">üóëÔ∏è Log wissen</button>
                    
                    <!-- Extra ruimte voor mobiel scrollen -->
                    <div style="height:120px"></div>
                </div>

                <!-- MORE -->
                <div class="screen" id="screenMore">
                    <div class="card">
                        <div class="section-title">üë§ Gebruiker</div>
                        <select class="select-field" id="userSelect" onchange="changeUser(this.value)" style="margin-bottom:12px"></select>
                        <div class="input-row"><input type="text" class="input-field" id="newUserInput" placeholder="Nieuwe gebruiker..."><button class="btn btn-primary" onclick="addUser()">+</button></div>
                    </div>
                    <div class="card">
                        <div class="section-title">üñ®Ô∏è Bluetooth Printer (Niimbot B3S)</div>
                        <div id="printerStatus" style="padding:12px;background:var(--bg);border-radius:10px;margin-bottom:12px;display:flex;align-items:center;gap:10px">
                            <span id="printerStatusIcon" style="font-size:20px">‚ö™</span>
                            <div style="flex:1">
                                <div id="printerStatusText" style="font-size:14px;font-weight:500">Niet verbonden</div>
                                <div id="printerStatusSub" style="font-size:11px;color:var(--text-muted)">Klik om te verbinden</div>
                            </div>
                        </div>
                        <button class="btn btn-secondary btn-full" onclick="connectBluetoothPrinter()" id="printerConnectBtn" style="margin-bottom:8px">üîó Verbind Printer</button>
                        <button class="btn btn-secondary btn-full" onclick="testPrintLabel()" id="printerTestBtn" style="display:none">üß™ Test Print</button>
                    </div>
                    <div class="card">
                        <div class="section-title">‚ûï Nieuw Artikel</div>
                        <button class="btn btn-success btn-full" onclick="showScreen('newArticle')">Nieuw artikel aanmaken</button>
                    </div>
                    <div class="card">
                        <div class="section-title">üè∑Ô∏è QR Labels</div>
                        <button class="btn btn-secondary btn-full" onclick="showScreen('qrlabels')" style="margin-bottom:10px">QR labels genereren</button>
                    </div>
                    <div class="card">
                        <div class="section-title">üîß Instellingen</div>
                        <div class="form-group"><label class="form-label">Notion API Key</label><input type="password" class="input-field" id="settingsApiKey"></div>
                        <button class="btn btn-secondary btn-full" onclick="saveApiKey()" style="margin-bottom:10px">üîó Test & Opslaan</button>
                        <button class="btn btn-secondary btn-full" onclick="reloadData()" style="margin-bottom:10px">üîÑ Data herladen</button>
                        <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-top:1px solid var(--border);margin-top:10px">
                            <span style="font-size:14px">üêõ Debug modus</span>
                            <label style="position:relative;width:50px;height:26px">
                                <input type="checkbox" id="debugToggle" onchange="toggleDebug()" style="opacity:0;width:0;height:0">
                                <span style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:var(--bg);border:1px solid var(--border);border-radius:26px;transition:.3s"></span>
                                <span id="debugToggleKnob" style="position:absolute;height:20px;width:20px;left:3px;bottom:3px;background:var(--text-muted);border-radius:50%;transition:.3s"></span>
                            </label>
                        </div>
                        <button class="btn btn-secondary btn-full" onclick="clearAllData()" style="opacity:0.6;margin-top:10px">üóëÔ∏è Alle data wissen</button>
                    </div>
                    
                    <!-- Extra ruimte voor mobiel scrollen -->
                    <div style="height:120px"></div>
                </div>

                <!-- QR LABELS -->
                <div class="screen" id="screenQrlabels">
                    <div class="card">
                        <div class="section-title">üè∑Ô∏è QR Labels Genereren</div>
                        <p style="font-size:13px;color:var(--text-muted);margin-bottom:16px">Selecteer artikelen om QR labels te genereren. Print deze pagina om labels te maken.</p>
                        
                        <div class="search-container">
                            <span class="search-icon">üîç</span>
                            <input type="text" class="search-input" id="qrSearchInput" placeholder="Zoek artikel..." oninput="filterQRProducts()">
                        </div>
                        
                        <!-- Filter: alleen zonder QR code -->
                        <label style="display:flex;align-items:center;gap:8px;margin-bottom:12px;font-size:13px;cursor:pointer">
                            <input type="checkbox" id="qrFilterNoCode" onchange="filterQRProducts()" style="width:18px;height:18px">
                            Alleen artikelen zonder QR code tonen
                        </label>
                        
                        <div style="display:flex;gap:8px;margin-bottom:12px">
                            <button class="btn btn-secondary" onclick="selectAllQR()" style="flex:1;padding:10px;font-size:12px">Alles selecteren</button>
                            <button class="btn btn-secondary" onclick="deselectAllQR()" style="flex:1;padding:10px;font-size:12px">Niets selecteren</button>
                        </div>
                        
                        <div id="qrProductList" style="max-height:250px;overflow-y:auto;background:var(--bg);border-radius:10px;padding:8px"></div>
                        
                        <div style="margin-top:16px;padding:12px;background:var(--bg);border-radius:10px;text-align:center">
                            <span style="font-size:14px" id="qrSelectedCount">0 artikelen geselecteerd</span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="section-title">üè∑Ô∏è Label Formaat</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">
                            <label class="label-format-option" onclick="selectLabelFormat('square')" style="display:flex;flex-direction:column;align-items:center;padding:16px 8px;background:var(--bg);border-radius:10px;cursor:pointer;border:2px solid var(--accent)" id="labelFormatSquare">
                                <input type="radio" name="labelFormat" value="square" checked style="display:none">
                                <span style="font-size:24px;margin-bottom:6px">‚¨ú</span>
                                <span style="font-size:12px;font-weight:600">Vierkant</span>
                                <span style="font-size:10px;color:var(--text-muted)">25x25mm</span>
                            </label>
                            <label class="label-format-option" onclick="selectLabelFormat('small')" style="display:flex;flex-direction:column;align-items:center;padding:16px 8px;background:var(--bg);border-radius:10px;cursor:pointer;border:2px solid var(--border)" id="labelFormatSmall">
                                <input type="radio" name="labelFormat" value="small" style="display:none">
                                <span style="font-size:24px;margin-bottom:6px">‚ñ¨</span>
                                <span style="font-size:12px;font-weight:600">Klein</span>
                                <span style="font-size:10px;color:var(--text-muted)">40x30mm</span>
                            </label>
                            <label class="label-format-option" onclick="selectLabelFormat('medium')" style="display:flex;flex-direction:column;align-items:center;padding:16px 8px;background:var(--bg);border-radius:10px;cursor:pointer;border:2px solid var(--border)" id="labelFormatMedium">
                                <input type="radio" name="labelFormat" value="medium" style="display:none">
                                <span style="font-size:24px;margin-bottom:6px">‚ñ≠</span>
                                <span style="font-size:12px;font-weight:600">Medium</span>
                                <span style="font-size:10px;color:var(--text-muted)">50x30mm</span>
                            </label>
                        </div>
                        <p style="font-size:11px;color:var(--text-muted);margin-top:10px">üí° Niimbot B3S compatibel</p>
                        <div style="margin-top:12px">
                            <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer">
                                <input type="checkbox" id="qrSaveToNotion" checked style="width:20px;height:20px">
                                QR codes opslaan in Notion
                            </label>
                        </div>
                    </div>
                    
                    <div style="display:flex;gap:10px;flex-wrap:wrap">
                        <button class="btn btn-primary" onclick="generateQRLabels()" style="flex:1;min-width:140px">üìÑ PDF Genereren</button>
                        <button class="btn btn-success" onclick="printToNiimbot()" id="niimbotPrintBtn" style="flex:1;min-width:140px">üñ®Ô∏è Print Niimbot</button>
                    </div>
                    <p id="niimbotPrintStatus" style="font-size:11px;color:var(--text-muted);text-align:center;margin-top:8px"></p>
                    
                    <!-- Extra ruimte voor mobiel scrollen -->
                    <div style="height:120px"></div>
                </div>

                <!-- NEW ARTICLE -->
                <div class="screen" id="screenNewArticle">
                    <div class="card">
                        <div class="section-title">üì∑ Barcode</div>
                        <div style="background:var(--bg);border-radius:10px;padding:14px;font-family:'JetBrains Mono',monospace;font-size:18px;text-align:center;margin-bottom:12px" id="newArticleBarcode">-</div>
                        <div class="input-row" style="margin-bottom:8px">
                            <button class="btn btn-secondary" onclick="scanForNewArticle()" style="flex:1">üì∑ Scan</button>
                            <button class="btn btn-secondary" onclick="generateBarcode()" style="flex:1">üî¢ Genereer</button>
                        </div>
                        <input type="text" class="input-field" id="newBarcodeInput" placeholder="Of typ handmatig..." oninput="updateNewBarcode(this.value)">
                    </div>
                    <div class="card">
                        <div class="section-title">üìù Gegevens</div>
                        <div class="form-group"><label class="form-label">Omschrijving *</label><input type="text" class="input-field" id="newName" placeholder="Bijv. Schroef 4x40"></div>
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">Hoofdgroep *</label><select class="select-field" id="newCategory"><option value="">Kies...</option><option value="BEVESTIGING">Bevestiging</option><option value="BESLAG">Beslag</option><option value="LIJM / KIT">Lijm / Kit</option><option value="PLAATMATERIAAL">Plaatmateriaal</option><option value="SCHUREN">Schuren</option><option value="ELECTRA">Electra</option><option value="VERFKOT">Verfkot</option></select></div>
                            <div class="form-group"><label class="form-label">Eenheid *</label><select class="select-field" id="newUnit"><option value="">Kies...</option><option value="stuk">stuk</option><option value="doos">doos</option><option value="pak">pak</option><option value="meter">meter</option><option value="rol">rol</option><option value="plaat">plaat</option></select></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">Prijs (‚Ç¨)</label><input type="number" step="0.01" class="input-field" id="newPrice" placeholder="0.00"></div>
                            <div class="form-group"><label class="form-label">Begin stock</label><input type="number" class="input-field" id="newStock" placeholder="0"></div>
                        </div>
                        <div class="form-group"><label class="form-label">Leverancier</label><select class="select-field" id="newSupplier"><option value="">Kies...</option><option value="NV Berner Belgien">Berner</option><option value="LMC">LMC</option><option value="LECOT">Lecot</option><option value="Festool">Festool</option><option value="H√§fele">H√§fele</option></select></div>
                    </div>
                    <button class="btn btn-success btn-full" onclick="saveNewArticle()">‚úì Artikel Opslaan</button>
                    
                    <!-- Extra ruimte voor mobiel scrollen -->
                    <div style="height:120px"></div>
                </div>
            </main>

            <!-- Fixed Debug Console - Collapsible -->
            <div id="debugConsole" style="display:none;position:fixed;bottom:70px;left:0;right:0;z-index:90;transition:transform 0.3s">
                <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 16px;background:var(--card);border-top:2px solid var(--accent);cursor:pointer" onclick="toggleDebugPanel()">
                    <span style="font-size:12px;font-weight:600">üêõ Debug Log <span id="debugToggleArrow">‚ñº</span></span>
                    <button onclick="event.stopPropagation();clearDebugLog()" style="padding:4px 8px;font-size:10px;background:var(--border);border:none;border-radius:4px;color:var(--text)">Clear</button>
                </div>
                <div id="debugLogWrapper" style="max-height:150px;overflow:hidden;transition:max-height 0.3s;background:var(--card)">
                    <div id="debugLog" style="padding:8px 16px;max-height:150px;overflow-y:auto;font-family:'JetBrains Mono',monospace;font-size:10px;line-height:1.5"></div>
                </div>
            </div>

            <nav class="bottom-nav">
                <button class="nav-item active" id="navHome" onclick="showScreen('home')"><span class="nav-icon">üè†</span><span class="nav-label">Home</span></button>
                <button class="nav-item" id="navScan" onclick="showScreen('scan')"><span class="nav-icon">üì∑</span><span class="nav-label">Scan</span></button>
                <button class="nav-item" id="navArticles" onclick="showScreen('articles')"><span class="nav-icon">üìã</span><span class="nav-label">Artikelen</span></button>
                <button class="nav-item" id="navLog" onclick="showScreen('log');renderLog()"><span class="nav-icon">üìä</span><span class="nav-label">Log</span></button>
                <button class="nav-item" id="navMore" onclick="showScreen('more')"><span class="nav-icon">‚öôÔ∏è</span><span class="nav-label">Meer</span></button>
            </nav>
        </div>
    </div>
<script>
// === CONFIG ===
const STOCK_DB='ae9ddd17fe69439991851affe25714ce';
const PROJECTS_DB='aa8ba0ce47bb4399bfdf0e6852b0d568';
const REGISTRATIONS_DB='2412e803e23648a9a55df3b38975a84d';

// === STATE ===
let apiKey=localStorage.getItem('notion_api_key')||'';
let users=JSON.parse(localStorage.getItem('users')||'["BAS"]');
let userName=localStorage.getItem('user_name')||'BAS';
let products=[],filteredProducts=[],projects=[],activeProjects=[],archivedProjects=[];
let favorites=JSON.parse(localStorage.getItem('favorites')||'[]');
let history=JSON.parse(localStorage.getItem('scan_history')||'[]');
let scanLog=JSON.parse(localStorage.getItem('scan_log')||'[]');
let marginOverrides=JSON.parse(localStorage.getItem('margin_overrides')||'{}');
let currentProduct=null,quantity=1,currentScreen='home',screenHistory=['home'];
let photoStream=null,capturedPhoto=null;
let lastProjectId=localStorage.getItem('last_project_id')||'';
let lastProjectTime=parseInt(localStorage.getItem('last_project_time')||'0');
let linkingMode=false,linkingBarcode='',newArticleBarcode='';
const PROJECT_TIMEOUT=10*60*1000;
const categories=[{id:'all',name:'Alles',icon:'üì¶'},{id:'BEVESTIGING',name:'Bevestiging',icon:'üî©'},{id:'BESLAG',name:'Beslag',icon:'üîß'},{id:'LIJM / KIT',name:'Lijm/Kit',icon:'üß¥'},{id:'PLAATMATERIAAL',name:'Plaatmat.',icon:'ü™µ'},{id:'SCHUREN',name:'Schuren',icon:'üìÑ'},{id:'ELECTRA',name:'Electra',icon:'‚ö°'},{id:'VERFKOT',name:'Verfkot',icon:'üé®'}];
let activeCategory='all';

// === INIT ===
document.addEventListener('DOMContentLoaded',()=>{if(!users.includes('BAS'))users.unshift('BAS');apiKey?startApp():document.getElementById('setupScreen').style.display='flex';});

function saveSetup(){const key=document.getElementById('setupApiKey').value.trim();if(!key||(!key.startsWith('secret_')&&!key.startsWith('ntn_'))){showToast('Ongeldige API key','error');return;}testApiKey(key,true);}

async function testApiKey(key,isSetup){
    showLoading(true);
    debugLog('API key testen...',{keyPrefix:key.substring(0,10)+'...',isSetup});
    try{
        // Gebruik eigen Vercel proxy in productie
        const isLocalhost=window.location.hostname==='localhost'||window.location.hostname==='127.0.0.1';
        const url=isLocalhost
            ?`https://corsproxy.io/?${encodeURIComponent('https://api.notion.com/v1/databases/'+STOCK_DB)}`
            :`/api/notion?path=${encodeURIComponent('/v1/databases/'+STOCK_DB)}`;
        debugLog('Test URL',{url,proxy:isLocalhost?'corsproxy':'vercel'});
        const res=await fetch(url,{headers:{'Authorization':`Bearer ${key}`,'Notion-Version':'2022-06-28'}});
        debugLog('Test response',{status:res.status,ok:res.ok});
        if(!res.ok){
            const errorText=await res.text();
            debugLog('Test error',errorText);
            throw new Error('Ongeldige key: '+res.status);
        }
        localStorage.setItem('notion_api_key',key);apiKey=key;
        debugLog('API key opgeslagen');
        if(isSetup){document.getElementById('setupScreen').style.display='none';showToast('Verbonden!');startApp();}else{showToast('API key opgeslagen');}
    }catch(e){
        debugLog('Verbinding mislukt',e.message);
        showToast('Verbinding mislukt: '+e.message,'error');
    }
    showLoading(false);
}

async function startApp(){
    document.getElementById('mainApp').style.display='flex';
    document.getElementById('setupScreen').style.display='none';
    document.getElementById('headerUser').textContent=userName+' ‚ñº';
    document.getElementById('settingsApiKey').value=apiKey;
    renderUserSelect();renderCategoryPills();renderHistory();renderFavorites();updateStats();
    
    // Load data but don't block the app if it fails
    try{
        await Promise.all([loadProducts(),loadProjects()]);
    }catch(e){
        debugLog('Data laden mislukt',e.message);
        console.error('Data load error:',e);
    }
}

// === API ===
async function notionRequest(endpoint,method='GET',body=null){
    // Gebruik eigen Vercel proxy in productie, corsproxy als fallback voor dev
    const isLocalhost=window.location.hostname==='localhost'||window.location.hostname==='127.0.0.1';
    const proxyUrl=isLocalhost
        ?`https://corsproxy.io/?${encodeURIComponent('https://api.notion.com/v1'+endpoint)}`
        :`/api/notion?path=${encodeURIComponent('/v1'+endpoint)}`;
    
    const opts={
        method,
        headers:{
            'Authorization':`Bearer ${apiKey}`,
            'Notion-Version':'2022-06-28',
            'Content-Type':'application/json'
        }
    };
    if(body)opts.body=JSON.stringify(body);
    
    debugLog(`API ${method} ${endpoint}`,{proxy:isLocalhost?'corsproxy':'vercel'});
    
    const res=await fetch(proxyUrl,opts);
    
    if(!res.ok){
        const errorText=await res.text();
        let errorDetail='';
        try{
            const errorJson=JSON.parse(errorText);
            errorDetail=errorJson.message||errorJson.code||errorText;
            debugLog('API ERROR',{status:res.status,error:errorJson});
        }catch(e){
            errorDetail=errorText;
            debugLog('API ERROR',{status:res.status,error:errorText});
        }
        throw new Error(`API ${res.status}: ${errorDetail}`);
    }
    
    const data=await res.json();
    debugLog(`API response OK`,{hasResults:!!data.results,id:data.id});
    return data;
}

// === DATA ===
async function loadProducts(){
    showLoading(true);
    debugLog('Products laden van Notion...');
    try{
        let all=[],hasMore=true,cursor,pageNum=0;
        while(hasMore){
            pageNum++;
            const body={filter:{property:'TYPE ITEM',select:{equals:'STOCK'}},page_size:100};
            if(cursor)body.start_cursor=cursor;
            debugLog(`Notion query pagina ${pageNum}`,{cursor:cursor||'start'});
            const res=await notionRequest(`/databases/${STOCK_DB}/query`,'POST',body);
            const items=res.results.map(p=>({id:p.id,name:p.properties['OMSCHRIJVIN']?.title?.[0]?.plain_text||'',barcode:p.properties[' ID (barcode)']?.rich_text?.[0]?.plain_text||'',supplierCode:p.properties[' ARTIKEL CODE LEVERANCIER']?.rich_text?.[0]?.plain_text||'',category:p.properties['HOOFDGROEP']?.select?.name||'',price:p.properties['AANKOOP PRIJS ']?.number||0,margin:p.properties['MARGE / VERWERKINGSTOESLAG']?.number||0.2,stock:p.properties['stock totaal']?.formula?.number??p.properties['STOCK (begin 2023) manual overrule']?.number??0,unit:p.properties['EENHEID']?.select?.name||'',minStock:p.properties['MINIMUM STOCK']?.number||0,idealStock:p.properties['IDEALE STOCK']?.number||0,supplier:p.properties['Leverancier']?.select?.name||'',imageUrl:p.properties['Afbeelding']?.files?.[0]?.external?.url||p.properties['Afbeelding']?.files?.[0]?.file?.url||''}));
            debugLog(`Pagina ${pageNum} resultaat`,{items:items.length,hasMore:res.has_more});
            all=[...all,...items];hasMore=res.has_more;cursor=res.next_cursor;
        }
        products=all.sort((a,b)=>(a.name||'').localeCompare(b.name||''));
        debugLog('Products geladen',{
            totaal:products.length,
            metBarcode:products.filter(p=>p.barcode).length,
            zonderBarcode:products.filter(p=>!p.barcode).length
        });
        // Log first 5 barcodes for debugging
        debugLog('Eerste 5 barcodes',products.slice(0,5).map(p=>({name:p.name.substring(0,30),barcode:p.barcode})));
        filterProducts();updateStats();showToast(`${products.length} artikelen`);
    }catch(e){
        debugLog('Laden mislukt',e.message);
        showToast('Laden mislukt','error');
    }
    showLoading(false);
}

async function loadProjects(){
    try{
        const [resA,resB]=await Promise.all([
            notionRequest(`/databases/${PROJECTS_DB}/query`,'POST',{filter:{and:[{property:'FASE PROJECT',status:{does_not_equal:'Gearchiveerd'}},{property:'Archiveren',checkbox:{equals:false}}]},sorts:[{property:'PROJECT NUMBER  (new)',direction:'descending'}],page_size:100}),
            notionRequest(`/databases/${PROJECTS_DB}/query`,'POST',{filter:{or:[{property:'FASE PROJECT',status:{equals:'Gearchiveerd'}},{property:'Archiveren',checkbox:{equals:true}}]},sorts:[{property:'PROJECT NUMBER  (new)',direction:'descending'}],page_size:50})
        ]);
        const map=p=>({id:p.id,name:p.properties['Project name  (KLANT_PROJECTNAAM)']?.title?.[0]?.plain_text||'',number:p.properties['PROJECT NUMBER  (new)']?.unique_id?.number||0});
        activeProjects=resA.results.map(map).filter(p=>p.name);
        archivedProjects=resB.results.map(map).filter(p=>p.name);
        projects=[...activeProjects,...archivedProjects];
        renderProjectSelect();
    }catch(e){console.error(e);}
}

// === NAVIGATION ===
function showScreen(screen){
    if(currentScreen==='scan')stopScanner();
    if(currentScreen==='product')hideAllPanels();
    if(!['product','newArticle','qrlabels'].includes(screen))screenHistory=[screen];
    else screenHistory.push(screen);
    currentScreen=screen;
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
    document.getElementById('screen'+screen.charAt(0).toUpperCase()+screen.slice(1))?.classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
    const navMap={home:'navHome',scan:'navScan',articles:'navArticles',log:'navLog',more:'navMore',qrlabels:'navMore'};
    document.getElementById(navMap[screen])?.classList.add('active');
    const titles={home:'Stock Scanner',scan:'Scannen',articles:'Artikelen',product:'Artikel',log:'Scan Log',more:'Instellingen',newArticle:'Nieuw Artikel',qrlabels:'QR Labels'};
    document.getElementById('headerTitle').textContent=titles[screen]||'Stock Scanner';
    document.getElementById('backBtn').classList.toggle('visible',['product','newArticle','qrlabels'].includes(screen));
    
    // Auto-start scanner when entering scan screen
    if(screen==='scan'){
        setTimeout(()=>startScanner(),300);
    }
}

function goBack(){screenHistory.pop();showScreen(screenHistory[screenHistory.length-1]||'home');}

// === BARCODE SCANNER (ZXing-js) ===
let pendingCode='';
let pendingFormat='';
let debugMode=false;
let recentScans=[];
const STABILITY_COUNT=2; // Need 2 identical scans
const STABILITY_WINDOW=1500; // Within 1.5 seconds

function debugLog(msg,data=null){
    if(!debugMode)return;
    const time=new Date().toLocaleTimeString('nl-BE');
    const logDiv=document.getElementById('debugLog');
    let entry=`<div style="border-bottom:1px solid var(--border);padding:4px 0"><span style="color:var(--accent)">[${time}]</span> ${msg}`;
    if(data!==null){
        entry+=`<div style="color:var(--text-muted);margin-left:12px">${typeof data==='object'?JSON.stringify(data,null,1):data}</div>`;
    }
    entry+='</div>';
    logDiv.innerHTML=entry+logDiv.innerHTML;
    // Keep max 50 entries
    const entries=logDiv.querySelectorAll(':scope > div');
    if(entries.length>50)entries[entries.length-1].remove();
    console.log(`[DEBUG] ${msg}`,data);
}

function clearDebugLog(){
    document.getElementById('debugLog').innerHTML='<div style="color:var(--text-muted)">Log gewist</div>';
}

let debugPanelOpen=true;
function toggleDebugPanel(){
    debugPanelOpen=!debugPanelOpen;
    document.getElementById('debugLogWrapper').style.maxHeight=debugPanelOpen?'150px':'0px';
    document.getElementById('debugToggleArrow').textContent=debugPanelOpen?'‚ñº':'‚ñ≤';
}

function toggleDebug(){
    debugMode=document.getElementById('debugToggle').checked;
    document.getElementById('debugConsole').style.display=debugMode?'block':'none';
    const knob=document.getElementById('debugToggleKnob');
    knob.style.left=debugMode?'27px':'3px';
    knob.style.background=debugMode?'var(--success)':'var(--text-muted)';
    localStorage.setItem('debug_mode',debugMode?'1':'0');
    if(debugMode)debugLog('Debug modus ingeschakeld');
}

// Html5Qrcode Scanner
let html5QrCode=null;
let scannerStarting=false;

async function startScanner(){
    if(scannerStarting){
        debugLog('Scanner al aan het starten, wachten...');
        return;
    }
    
    if(html5QrCode&&html5QrCode.isScanning){
        debugLog('Scanner al actief');
        return;
    }
    
    scannerStarting=true;
    document.getElementById('scannerPlaceholder').style.display='none';
    document.getElementById('scanStatus').textContent='Camera starten...';
    document.getElementById('barcodeConfirm').style.display='none';
    recentScans=[];
    
    debugLog('Html5Qrcode scanner starten...');
    
    try{
        // Check if library is available
        if(typeof Html5Qrcode==='undefined'){
            throw new Error('Html5Qrcode library niet geladen');
        }
        
        // Create scanner instance
        html5QrCode=new Html5Qrcode('scannerReader',{verbose:false});
        
        // Get cameras
        let cameras=[];
        try{
            cameras=await Html5Qrcode.getCameras();
            debugLog('Beschikbare cameras',cameras.length?cameras.map(c=>({id:c.id.slice(0,8),label:c.label})):'geen');
        }catch(camErr){
            debugLog('Camera lijst fout',camErr.message);
        }
        
        // Find back camera
        let cameraId=null;
        if(cameras.length>0){
            const backCam=cameras.find(c=>
                c.label&&(
                    c.label.toLowerCase().includes('back')||
                    c.label.toLowerCase().includes('rear')||
                    c.label.toLowerCase().includes('environment')||
                    c.label.toLowerCase().includes('achter')
                )
            );
            cameraId=backCam?backCam.id:cameras[cameras.length-1].id; // Last camera usually back on mobile
            debugLog('Camera geselecteerd',cameraId?cameraId.slice(0,8):'default');
        }
        
        const config={
            fps:10,
            qrbox:{width:250,height:150},
            aspectRatio:1.333,
            disableFlip:false,
            formatsToSupport:[
                Html5QrcodeSupportedFormats.QR_CODE,
                Html5QrcodeSupportedFormats.EAN_13,
                Html5QrcodeSupportedFormats.EAN_8,
                Html5QrcodeSupportedFormats.CODE_128,
                Html5QrcodeSupportedFormats.CODE_39,
                Html5QrcodeSupportedFormats.UPC_A,
                Html5QrcodeSupportedFormats.UPC_E,
                Html5QrcodeSupportedFormats.DATA_MATRIX
            ]
        };
        
        const onSuccess=(decodedText,decodedResult)=>{
            handleScanSuccess(decodedText,decodedResult.result.format?.formatName||'UNKNOWN');
        };
        
        const onError=(err)=>{
            // Normal when no code in view, ignore
        };
        
        // Start scanning
        if(cameraId){
            await html5QrCode.start(cameraId,config,onSuccess,onError);
        }else{
            await html5QrCode.start({facingMode:'environment'},config,onSuccess,onError);
        }
        
        document.getElementById('scannerBox').classList.add('active');
        document.getElementById('scanStatus').textContent='Zoeken naar code...';
        document.getElementById('scanStatus').className='scan-status detecting';
        debugLog('Html5Qrcode scanner actief');
        
    }catch(e){
        console.error('Scanner error:',e);
        debugLog('Scanner error',e.message||e);
        showToast('Camera fout: '+e.message,'error');
        document.getElementById('scannerPlaceholder').style.display='flex';
        document.getElementById('scanStatus').textContent='Tik om opnieuw te proberen';
    }finally{
        scannerStarting=false;
    }
}

function handleScanSuccess(decodedText,format){
    const now=Date.now();
    
    // Parse GS1 DataMatrix als het een GS1 code is
    const gs1Data=parseGS1(decodedText);
    const displayCode=gs1Data?gs1Data.displayCode:decodedText;
    const searchCode=gs1Data?gs1Data.searchCode:decodedText;
    
    debugLog('Scan gedetecteerd',{
        raw:decodedText,
        format:format,
        isGS1:!!gs1Data,
        gs1:gs1Data
    });
    
    // Add to recent scans (use searchCode for stability)
    recentScans.push({code:searchCode,format:format,time:now,raw:decodedText,gs1:gs1Data});
    
    // Remove old scans outside window
    recentScans=recentScans.filter(s=>now-s.time<STABILITY_WINDOW);
    
    // Check for stability (same code scanned multiple times)
    const matchingScans=recentScans.filter(s=>s.code===searchCode);
    
    debugLog('Stabiliteit check',{
        recentScans:recentScans.length,
        matchingScans:matchingScans.length,
        required:STABILITY_COUNT
    });
    
    if(matchingScans.length>=STABILITY_COUNT){
        // Stable scan! Stop scanning and show confirmation
        debugLog('Stabiele code gevonden!',{code:searchCode,format:format,gs1:gs1Data});
        
        if(navigator.vibrate)navigator.vibrate([100,50,100]);
        
        pendingCode=searchCode;
        pendingFormat=format;
        pendingGS1=gs1Data;
        recentScans=[];
        
        // Pause scanner
        if(html5QrCode&&html5QrCode.isScanning){
            html5QrCode.pause(true);
            debugLog('Scanner gepauzeerd voor bevestiging');
        }
        
        // Toon scan resultaat
        document.getElementById('scannedBarcodeValue').textContent=displayCode;
        
        // Toon GS1 details als beschikbaar
        let formatText='Type: '+format;
        if(gs1Data){
            formatText='GS1 DataMatrix';
            if(gs1Data.gtin)formatText+=` ‚Ä¢ GTIN: ${gs1Data.gtin}`;
            if(gs1Data.batch)formatText+=` ‚Ä¢ Batch: ${gs1Data.batch}`;
            if(gs1Data.serial)formatText+=` ‚Ä¢ SN: ${gs1Data.serial}`;
        }
        document.getElementById('scannedBarcodeFormat').textContent=formatText;
        
        document.getElementById('barcodeConfirm').style.display='block';
        document.getElementById('scanStatus').textContent='Code gevonden!';
        document.getElementById('scanStatus').className='scan-status found';
    }
}

// GS1 DataMatrix Parser
// Parset Application Identifiers uit GS1 codes
let pendingGS1=null;

function parseGS1(data){
    if(!data)return null;
    
    // GS1 DataMatrix begint vaak met ]d2 of ]C1 (symbology identifier)
    // Of bevat GS (Group Separator, ASCII 29) karakters
    let cleanData=data;
    let isGS1=false;
    
    // Verwijder symbology identifier
    if(cleanData.startsWith(']d2')||cleanData.startsWith(']C1')||cleanData.startsWith(']e0')){
        cleanData=cleanData.substring(3);
        isGS1=true;
    }
    
    // Check voor FNC1 in eerste positie (GS1 indicator)
    const GS=String.fromCharCode(29); // Group Separator
    if(cleanData.includes(GS)){
        isGS1=true;
    }
    
    // Als het begint met 01, 02, 10, 21, 17 etc is het waarschijnlijk GS1
    if(/^(01|02|10|11|17|21|30|37)\d/.test(cleanData)){
        isGS1=true;
    }
    
    if(!isGS1)return null;
    
    // Parse Application Identifiers
    const result={
        raw:data,
        gtin:null,
        batch:null,
        serial:null,
        expiry:null,
        prodDate:null,
        count:null,
        other:{}
    };
    
    // AI definities: {length: fixed length of null voor variabel, maxLength: max voor variabel}
    const aiDefs={
        '00':{len:18,name:'SSCC'},
        '01':{len:14,name:'GTIN'},
        '02':{len:14,name:'GTIN Content'},
        '10':{len:null,max:20,name:'Batch/Lot'},
        '11':{len:6,name:'Prod Date'},
        '13':{len:6,name:'Pack Date'},
        '15':{len:6,name:'Best Before'},
        '17':{len:6,name:'Expiry Date'},
        '21':{len:null,max:20,name:'Serial'},
        '30':{len:null,max:8,name:'Var Count'},
        '37':{len:null,max:8,name:'Count'},
        '310':{len:6,name:'Net Weight kg'},
        '320':{len:6,name:'Net Weight lb'},
        '91':{len:null,max:90,name:'Internal'},
        '92':{len:null,max:90,name:'Internal'},
        '93':{len:null,max:90,name:'Internal'}
    };
    
    let pos=0;
    let iterations=0;
    const maxIterations=20;
    
    while(pos<cleanData.length&&iterations<maxIterations){
        iterations++;
        
        // Sla GS karakters over
        if(cleanData[pos]===GS){
            pos++;
            continue;
        }
        
        // Probeer AI te matchen (2, 3 of 4 cijfers)
        let ai=null;
        let aiDef=null;
        
        for(const aiLen of [4,3,2]){
            const testAI=cleanData.substring(pos,pos+aiLen);
            // Check exacte match of prefix match voor variabele AI's
            if(aiDefs[testAI]){
                ai=testAI;
                aiDef=aiDefs[testAI];
                break;
            }
            // Check voor AI's met variabele laatste cijfer (bijv 310x)
            if(aiLen>=3&&aiDefs[testAI.substring(0,3)]){
                ai=testAI;
                aiDef=aiDefs[testAI.substring(0,3)];
                break;
            }
        }
        
        if(!ai){
            // Geen bekende AI, stop parsing
            debugLog('GS1 parse stop: onbekende AI op positie '+pos,cleanData.substring(pos,pos+10));
            break;
        }
        
        pos+=ai.length;
        
        // Haal waarde op
        let value='';
        if(aiDef.len){
            // Fixed length
            value=cleanData.substring(pos,pos+aiDef.len);
            pos+=aiDef.len;
        }else{
            // Variable length - tot GS of einde
            const gsPos=cleanData.indexOf(GS,pos);
            if(gsPos>=0&&gsPos<pos+(aiDef.max||20)){
                value=cleanData.substring(pos,gsPos);
                pos=gsPos+1;
            }else{
                // Tot max lengte of einde string
                const maxLen=aiDef.max||20;
                value=cleanData.substring(pos,pos+maxLen);
                // Zoek naar begin van volgende AI (2 cijfers gevolgd door meer)
                for(let i=1;i<value.length-1;i++){
                    const testAI=value.substring(i,i+2);
                    if(aiDefs[testAI]||aiDefs[value.substring(i,i+3)]||aiDefs[value.substring(i,i+4)]){
                        value=value.substring(0,i);
                        break;
                    }
                }
                pos+=value.length;
            }
        }
        
        // Sla waarde op
        debugLog('GS1 AI geparsed',{ai,name:aiDef.name,value});
        
        switch(ai){
            case '01':
            case '02':
                result.gtin=value;
                break;
            case '10':
                result.batch=value;
                break;
            case '21':
                result.serial=value;
                break;
            case '17':
            case '15':
                result.expiry=value;
                break;
            case '11':
            case '13':
                result.prodDate=value;
                break;
            case '30':
            case '37':
                result.count=value;
                break;
            default:
                result.other[ai]=value;
        }
    }
    
    // Maak display en search codes
    // SearchCode: gebruik GTIN of Serial voor lookup
    result.searchCode=result.gtin||result.serial||result.batch||cleanData;
    
    // DisplayCode: kort leesbaar formaat
    let display=[];
    if(result.gtin)display.push(result.gtin);
    if(result.batch)display.push('Batch:'+result.batch);
    if(result.serial)display.push('SN:'+result.serial);
    result.displayCode=display.length?display.join(' '):cleanData;
    
    return result;
}

async function stopScanner(){
    debugLog('Scanner stoppen...');
    if(html5QrCode){
        try{
            if(html5QrCode.isScanning){
                await html5QrCode.stop();
            }
        }catch(e){
            debugLog('Stop error (negeren)',e.message);
        }
        html5QrCode=null;
    }
    document.getElementById('scannerReader').innerHTML='';
    document.getElementById('scannerBox').classList.remove('active');
    document.getElementById('scannerPlaceholder').style.display='flex';
    document.getElementById('scanStatus').textContent='Camera niet actief';
    document.getElementById('scanStatus').className='scan-status';
    document.getElementById('barcodeConfirm').style.display='none';
    document.getElementById('ocrResults').innerHTML='';
    pendingCode='';
    pendingFormat='';
    pendingGS1=null;
    recentScans=[];
}

async function rejectScan(){
    debugLog('Scan verworpen, opnieuw starten');
    pendingCode='';
    pendingFormat='';
    pendingGS1=null;
    recentScans=[];
    document.getElementById('barcodeConfirm').style.display='none';
    document.getElementById('scanStatus').textContent='Zoeken naar code...';
    document.getElementById('scanStatus').className='scan-status detecting';
    
    // Resume Html5Qrcode scanner
    if(html5QrCode&&!html5QrCode.isScanning){
        try{
            await html5QrCode.resume();
        }catch(e){
            // If resume fails, restart completely
            await stopScanner();
            await startScanner();
        }
    }else{
        await startScanner();
    }
}

async function acceptScan(){
    const code=pendingCode;
    debugLog('Scan geaccepteerd',{code:code,format:pendingFormat});
    await stopScanner();
    document.getElementById('barcodeInput').value=code;
    lookupBarcode();
}

function lookupBarcode(){
    var input=document.getElementById('barcodeInput').value.trim();
    if(!input){showToast('Voer code in','error');return;}
    
    debugLog('Zoeken naar product',{input:input,hasGS1:!!pendingGS1});
    
    var norm=function(b){return(b||'').trim().toUpperCase();};
    var search=norm(input);
    var found=null;
    
    // Als we GS1 data hebben, zoek eerst op GTIN
    if(pendingGS1&&pendingGS1.gtin){
        const gtin=pendingGS1.gtin;
        debugLog('Zoeken op GTIN',{gtin:gtin});
        
        // GTIN-14 kan voorloopnullen hebben, probeer verschillende variaties
        const gtinVariants=[
            gtin,
            gtin.replace(/^0+/,''), // Zonder voorloopnullen
            '0'+gtin.replace(/^0+/,''), // Met 1 voorloopnul
            gtin.substring(1), // GTIN-13 uit GTIN-14
            gtin.substring(0,13) // Eerste 13 cijfers
        ];
        
        found=products.find(function(p){
            const pb=norm(p.barcode);
            return gtinVariants.some(g=>pb===norm(g)||pb.includes(norm(g)));
        });
        
        debugLog('GTIN match',{found:found?found.name:'geen'});
    }
    
    // Zoek op exacte barcode
    if(!found){
        found=products.find(function(p){return norm(p.barcode)===search;});
        debugLog('Exacte barcode match',{found:found?found.name:'geen'});
    }
    
    // Zoek op gedeeltelijke barcode
    if(!found){
        var ws='/'+search.replace(/^\//,''),wos=search.replace(/^\//,'');
        found=products.find(function(p){var pb=norm(p.barcode);return pb===ws||pb===wos||pb.includes(search)||search.includes(pb);});
        debugLog('Gedeeltelijke barcode match',{found:found?found.name:'geen'});
    }
    
    // Zoek op naam
    if(!found){
        var searchLower=input.toLowerCase();
        found=products.find(function(p){return p.name&&p.name.toLowerCase()===searchLower;});
        debugLog('Exacte naam match',{found:found?found.name:'geen'});
        
        if(!found){
            var matches=products.filter(function(p){return p.name&&p.name.toLowerCase().includes(searchLower);});
            debugLog('Gedeeltelijke naam matches',{count:matches.length});
            
            if(matches.length===1)found=matches[0];
            else if(matches.length>1){
                var resultsDiv=document.getElementById('ocrResults');
                var html='<div style="font-size:12px;color:var(--text-muted);margin-bottom:8px">Meerdere resultaten:</div><div class="ocr-results">';
                matches.slice(0,5).forEach(function(m){
                    html+='<div class="ocr-result-item" onclick="selectProduct(products.find(function(p){return p.id===\''+m.id+'\';}))"><div style="flex:1"><div style="font-size:14px;font-weight:500">'+esc(m.name)+'</div></div></div>';
                });
                resultsDiv.innerHTML=html+'</div>';
                return;
            }
        }
    }
    
    if(found){
        debugLog('Product gevonden',{id:found.id,name:found.name,barcode:found.barcode});
        document.getElementById('barcodeInput').value='';
        document.getElementById('ocrResults').innerHTML='';
        pendingGS1=null; // Reset GS1 data
        selectProduct(found);
    }else{
        debugLog('Geen product gevonden, toon link modal');
        // Gebruik GTIN als beschikbaar voor linken
        linkingBarcode=pendingGS1?.gtin||input;
        document.getElementById('linkModalBarcode').textContent=pendingGS1?
            `GS1: ${pendingGS1.gtin}${pendingGS1.batch?' (Batch: '+pendingGS1.batch+')':''}`:
            input;
        pendingGS1=null;
        openModal('linkModal');
    }
}

// === PRODUCTS ===
function filterProducts(){
    let f=[...products];
    if(activeCategory!=='all')f=f.filter(p=>p.category===activeCategory);
    const q=(document.getElementById('searchInput')?.value||'').toLowerCase();
    if(q)f=f.filter(p=>p.name?.toLowerCase().includes(q)||p.barcode?.toLowerCase().includes(q));
    f.sort((a,b)=>{const af=favorites.includes(a.id),bf=favorites.includes(b.id);if(af&&!bf)return -1;if(!af&&bf)return 1;return(a.name||'').localeCompare(b.name||'');});
    filteredProducts=f;renderProductList();
}

function renderProductList(){
    const list=document.getElementById('productList');
    document.getElementById('resultsCount').textContent=`${filteredProducts.length} artikelen`;
    if(!filteredProducts.length){list.innerHTML='<div class="empty-state"><div class="empty-state-icon">üîç</div><div>Geen artikelen</div></div>';return;}
    list.innerHTML=filteredProducts.map(p=>`<div class="product-item" onclick="selectProduct(products.find(x=>x.id==='${p.id}'))"><div class="product-icon">${p.imageUrl?`<img src="${p.imageUrl}" onerror="this.parentElement.textContent='${getCategoryIcon(p.category)}'">`:getCategoryIcon(p.category)}</div><div class="product-info"><div class="product-name">${esc(p.name)}</div><div class="product-meta"><span>${p.unit||'-'}</span><span>‚Ä¢</span><span>‚Ç¨${(p.price||0).toFixed(2)}</span></div></div><div class="product-stock ${(p.stock||0)<=(p.minStock||1)?'low':'ok'}">${p.stock||0}</div></div>`).join('');
}

function selectProduct(p){
    if(!p)return;
    if(linkingMode&&linkingBarcode){confirmLink(p);return;}
    currentProduct=p;quantity=1;
    const img=document.getElementById('productImage');
    img.innerHTML=p.imageUrl?`<img src="${p.imageUrl}" onerror="this.textContent='${getCategoryIcon(p.category)}'">`:`<span>${getCategoryIcon(p.category)}</span>`;
    document.getElementById('productName').textContent=p.name||'-';
    document.getElementById('productCategory').textContent=p.category||'-';
    document.getElementById('productBarcode').textContent=p.barcode||'Geen barcode';
    document.getElementById('productPrice').textContent=`‚Ç¨${(p.price||0).toFixed(2)}`;
    const st=document.getElementById('productStock');st.textContent=p.stock||0;st.className='stat-box-value stock'+((p.stock||0)<=(p.minStock||1)?' low':'');
    document.getElementById('productUnit').textContent=p.unit||'-';
    document.getElementById('quantityUnit').textContent=p.unit||'stuks';
    document.getElementById('quantityValue').textContent=1;
    document.getElementById('productFavoriteBtn').textContent=favorites.includes(p.id)?'‚≠ê':'‚òÜ';
    document.getElementById('editMinStock').value=p.minStock||'';
    document.getElementById('editIdealStock').value=p.idealStock||'';
    document.getElementById('currentBarcode').textContent=p.barcode||'Geen';
    const sel=document.getElementById('projectSelect');
    if(lastProjectId&&(Date.now()-lastProjectTime)<PROJECT_TIMEOUT)sel.value=lastProjectId;else sel.value='';
    hideAllPanels();showScreen('product');
}

async function confirmLink(product){
    if(!confirm(`Barcode "${linkingBarcode}" koppelen aan:\n\n${product.name}?`))return;
    showLoading(true);
    try{
        await notionRequest(`/pages/${product.id}`,'PATCH',{properties:{' ID (barcode)':{rich_text:[{text:{content:linkingBarcode}}]}}});
        product.barcode=linkingBarcode;const idx=products.findIndex(x=>x.id===product.id);if(idx>=0)products[idx].barcode=linkingBarcode;
        showToast('Barcode gekoppeld!');linkingMode=false;linkingBarcode='';renderLinkBanner();selectProduct(product);
    }catch(e){showToast('Koppelen mislukt','error');}
    showLoading(false);
}

function changeQuantity(d){quantity=Math.max(1,quantity+d);document.getElementById('quantityValue').textContent=quantity;}

async function registerAction(action){
    const projectId=document.getElementById('projectSelect').value;
    if(!projectId){showToast('Selecteer project','error');return;}
    if(!currentProduct)return;
    showLoading(true);
    
    debugLog('Registratie starten',{action,projectId,productId:currentProduct.id,productName:currentProduct.name});
    
    try{
        const qty=action==='Uitscannen'?-quantity:quantity;
        const proj=projects.find(p=>p.id===projectId);
        
        const payload={
            parent:{database_id:REGISTRATIONS_DB},
            properties:{
                'Omschrijving':{title:[{text:{content:`${currentProduct.name} - ${action}`}}]},
                'Actie':{select:{name:action}},
                'Aantal':{number:qty},
                'Medewerker':{rich_text:[{text:{content:userName}}]},
                'Eenheidsprijs':{number:currentProduct.price||0},
                'Datum':{date:{start:new Date().toISOString().split('T')[0]}},
                'Barcode':{rich_text:[{text:{content:currentProduct.barcode||''}}]},
                'Stock Artikel':{relation:[{id:currentProduct.id}]},
                'Project':{relation:[{id:projectId}]}
            }
        };
        
        debugLog('Notion payload',payload);
        
        const result=await notionRequest('/pages','POST',payload);
        
        debugLog('Registratie succesvol',{pageId:result?.id});
        
        currentProduct.stock=(currentProduct.stock||0)+qty;
        const idx=products.findIndex(x=>x.id===currentProduct.id);
        if(idx>=0)products[idx].stock=currentProduct.stock;
        document.getElementById('productStock').textContent=currentProduct.stock;
        lastProjectId=projectId;lastProjectTime=Date.now();
        localStorage.setItem('last_project_id',projectId);
        localStorage.setItem('last_project_time',lastProjectTime.toString());
        addToHistory({name:currentProduct.name,action,amount:qty,project:proj?.name||''});
        addToScanLog({
            notionPageId:result?.id,
            productId:currentProduct.id,
            productName:currentProduct.name,
            projectId,
            projectName:proj?.name||'',
            projectNumber:proj?.number||0,
            action,
            quantity:qty,
            price:currentProduct.price||0,
            margin:currentProduct.margin||0.2,
            user:userName
        });
        quantity=1;document.getElementById('quantityValue').textContent=1;
        showToast(`${Math.abs(qty)}x ${action==='Uitscannen'?'uit':'in'}`);
    }catch(e){
        console.error('Registratie fout:',e);
        debugLog('Registratie FOUT',{error:e.message,stack:e.stack});
        showToast('Fout: '+e.message,'error');
    }
    showLoading(false);
}

// === PANELS ===
function hideAllPanels(){['editPanel','linkPanel','photoPanel','qrPanel'].forEach(id=>document.getElementById(id).style.display='none');stopPhotoStream();}
function showPanel(p){
    hideAllPanels();
    if(p==='edit'&&currentProduct){
        document.getElementById('currentStockValue').textContent=currentProduct.stock||0;
    }
    if(p==='qr'&&currentProduct){
        updateQRPanel();
    }
    document.getElementById(p+'Panel').style.display='block';
}

function updateQRPanel(){
    if(!currentProduct)return;
    
    const code=currentProduct.barcode||'';
    const hasDMCode=code.startsWith('DM-');
    
    document.getElementById('qrCurrentCode').textContent=code||'Geen code';
    document.getElementById('qrHasDMCode').style.display=hasDMCode?'block':'none';
    document.getElementById('qrNoDMCode').style.display=hasDMCode?'none':'block';
    document.getElementById('qrGenerateBtn').textContent=hasDMCode?'üîÑ Nieuwe DM Code':'üîÑ Genereer DM Code';
    
    // Render QR preview
    const canvas=document.getElementById('qrPreviewCanvas');
    if(code){
        const qrCanvas=generateQRCanvas(code,100);
        const ctx=canvas.getContext('2d');
        canvas.width=100;
        canvas.height=100;
        ctx.drawImage(qrCanvas,0,0);
    }else{
        const ctx=canvas.getContext('2d');
        canvas.width=100;
        canvas.height=100;
        ctx.fillStyle='#1a1a2e';
        ctx.fillRect(0,0,100,100);
        ctx.fillStyle='#5a6078';
        ctx.font='12px Arial';
        ctx.textAlign='center';
        ctx.fillText('Geen code',50,55);
    }
}

async function generateProductQR(){
    if(!currentProduct)return;
    
    showLoading(true);
    try{
        // Get next DM code
        const nextCode=await getNextDMCode();
        const newCode='DM-'+String(nextCode).padStart(4,'0');
        
        // Save to Notion
        debugLog('QR code genereren en opslaan',{id:currentProduct.id,code:newCode});
        await notionRequest(`/pages/${currentProduct.id}`,'PATCH',{
            properties:{' ID (barcode)':{rich_text:[{text:{content:newCode}}]}}
        });
        
        // Update local
        currentProduct.barcode=newCode;
        const idx=products.findIndex(x=>x.id===currentProduct.id);
        if(idx>=0)products[idx].barcode=newCode;
        
        // Update display
        document.getElementById('productBarcode').textContent=newCode;
        updateQRPanel();
        
        showToast(`QR code ${newCode} toegewezen`);
        debugLog('QR code opgeslagen',{code:newCode});
        
    }catch(e){
        console.error('QR generate error:',e);
        debugLog('QR code genereren mislukt',e.message);
        showToast('Fout bij opslaan','error');
    }
    showLoading(false);
}

async function printProductQR(){
    if(!currentProduct)return;
    
    let code=currentProduct.barcode;
    
    // Generate code first if needed
    if(!code){
        await generateProductQR();
        code=currentProduct.barcode;
    }
    
    if(!code){
        showToast('Geen QR code','error');
        return;
    }
    
    // Check if printer is connected
    if(printerConnected){
        // Print directly to Niimbot
        showLoading(true);
        try{
            const canvas=await generateLabelCanvas(currentProduct);
            const ctx=canvas.getContext('2d');
            const imageData=ctx.getImageData(0,0,canvas.width,canvas.height);
            await printImageToNiimbot(imageData,canvas.width,canvas.height);
            showToast('Label geprint!');
        }catch(e){
            console.error('Print error:',e);
            showToast('Print mislukt','error');
        }
        showLoading(false);
    }else{
        // Open print window with single label
        const cfg={w:'40mm',h:'30mm',qr:'25mm',nameSize:'8pt',codeSize:'7pt'};
        const printWindow=window.open('','_blank');
        printWindow.document.write(`
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>QR Label - ${esc(currentProduct.name)}</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"><\/script>
    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        @page{size:auto;margin:5mm}
        body{font-family:Arial,sans-serif;display:flex;justify-content:center;padding:10mm}
        .label{width:${cfg.w};height:${cfg.h};border:1px dashed #ccc;padding:2mm;display:flex;align-items:center;background:#fff}
        .qr{width:${cfg.qr};height:${cfg.qr};flex-shrink:0}
        .qr canvas{width:100%!important;height:100%!important}
        .info{flex:1;padding-left:2mm;overflow:hidden}
        .name{font-size:${cfg.nameSize};font-weight:bold;margin-bottom:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .code{font-size:${cfg.codeSize};font-family:monospace;color:#333}
        @media print{.label{border:none}}
    </style>
</head>
<body>
    <div class="label">
        <div class="qr" id="qr"></div>
        <div class="info">
            <div class="name">${esc(currentProduct.name.substring(0,30))}</div>
            <div class="code">${esc(code)}</div>
        </div>
    </div>
    <script>
        QRCode.toCanvas(document.createElement('canvas'),'${code}',{width:200,margin:0},function(err,canvas){
            if(!err)document.getElementById('qr').appendChild(canvas);
        });
        setTimeout(function(){window.print();},500);
    <\/script>
</body>
</html>
        `);
        printWindow.document.close();
    }
}

async function saveProductEdits(){
    const min=parseInt(document.getElementById('editMinStock').value)||0;
    const ideal=parseInt(document.getElementById('editIdealStock').value)||0;
    showLoading(true);
    try{await notionRequest(`/pages/${currentProduct.id}`,'PATCH',{properties:{'MINIMUM STOCK':{number:min},'IDEALE STOCK':{number:ideal}}});currentProduct.minStock=min;currentProduct.idealStock=ideal;showToast('Opgeslagen');document.getElementById('editPanel').style.display='none';}catch(e){showToast('Fout','error');}
    showLoading(false);
}

async function saveStockCorrection(){
    const val=parseInt(document.getElementById('editStockValue').value);
    if(isNaN(val)){showToast('Ongeldige waarde','error');return;}
    
    // Calculate difference between new value and current stock
    const currentStock=currentProduct.stock||0;
    const difference=val-currentStock;
    
    if(difference===0){showToast('Geen wijziging','error');return;}
    
    showLoading(true);
    try{
        // Create a registration for the stock correction
        const corrResult = await notionRequest('/pages','POST',{
            parent:{database_id:REGISTRATIONS_DB},
            properties:{
                'Omschrijving':{title:[{text:{content:`${currentProduct.name} - Stock correctie`}}]},
                'Actie':{select:{name:'Stock correctie'}},
                'Aantal':{number:difference},
                'Medewerker':{rich_text:[{text:{content:userName}}]},
                'Eenheidsprijs':{number:currentProduct.price||0},
                'Datum':{date:{start:new Date().toISOString().split('T')[0]}},
                'Barcode':{rich_text:[{text:{content:currentProduct.barcode||''}}]},
                'Stock Artikel':{relation:[{id:currentProduct.id}]}
            }
        });
        
        currentProduct.stock=val;
        const idx=products.findIndex(x=>x.id===currentProduct.id);
        if(idx>=0)products[idx].stock=val;
        document.getElementById('productStock').textContent=val;
        document.getElementById('editStockValue').value='';
        
        addToScanLog({
            notionPageId:corrResult?.id,
            productId:currentProduct.id,
            productName:currentProduct.name,
            projectId:'',
            projectName:'Stock correctie',
            projectNumber:0,
            action:'Stock correctie',
            quantity:difference,
            price:currentProduct.price||0,
            margin:currentProduct.margin||0.2,
            user:userName
        });
        
        showToast(`Stock aangepast: ${currentStock} ‚Üí ${val} (${difference>0?'+':''}${difference})`);
    }catch(e){
        console.error(e);
        showToast('Fout bij opslaan','error');
    }
    showLoading(false);
}

function scanForLink(){showScreen('scan');showToast('Scan barcode om te koppelen');}

async function saveLinkedBarcode(){
    const bc=document.getElementById('linkBarcodeInput').value.trim();
    if(!bc){showToast('Voer barcode in','error');return;}
    showLoading(true);
    try{await notionRequest(`/pages/${currentProduct.id}`,'PATCH',{properties:{' ID (barcode)':{rich_text:[{text:{content:bc}}]}}});currentProduct.barcode=bc;document.getElementById('productBarcode').textContent=bc;document.getElementById('currentBarcode').textContent=bc;document.getElementById('linkBarcodeInput').value='';document.getElementById('linkPanel').style.display='none';showToast('Barcode gekoppeld');}catch(e){showToast('Fout','error');}
    showLoading(false);
}

// === PHOTO ===
async function startPhotoCapture(){
    if(capturedPhoto)return;
    try{photoStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});const v=document.getElementById('photoVideo');v.srcObject=photoStream;v.style.display='block';document.getElementById('photoPlaceholder').style.display='none';v.onclick=e=>{e.stopPropagation();takePhoto();};}catch(e){showToast('Camera niet beschikbaar','error');}
}

function takePhoto(){
    const v=document.getElementById('photoVideo');const c=document.createElement('canvas');const s=Math.min(v.videoWidth,v.videoHeight);c.width=c.height=s;
    c.getContext('2d').drawImage(v,(v.videoWidth-s)/2,(v.videoHeight-s)/2,s,s,0,0,s,s);
    capturedPhoto=c.toDataURL('image/jpeg',0.8);stopPhotoStream();
    document.getElementById('photoPreview').src=capturedPhoto;document.getElementById('photoPreview').style.display='block';
    document.getElementById('photoActions').style.display='flex';document.getElementById('photoCaptureBox').style.borderStyle='solid';document.getElementById('photoCaptureBox').style.borderColor='var(--success)';
}

function retakePhoto(){capturedPhoto=null;document.getElementById('photoPreview').style.display='none';document.getElementById('photoActions').style.display='none';document.getElementById('photoPlaceholder').style.display='flex';document.getElementById('photoCaptureBox').style.borderStyle='dashed';document.getElementById('photoCaptureBox').style.borderColor='var(--border)';startPhotoCapture();}
function stopPhotoStream(){if(photoStream){photoStream.getTracks().forEach(t=>t.stop());photoStream=null;}document.getElementById('photoVideo').style.display='none';}

async function savePhoto(){
    if(!capturedPhoto)return;
    const key=localStorage.getItem('imgbbApiKey')||'';
    if(!key){const k=prompt('imgBB API key nodig. Ga naar api.imgbb.com:');if(!k)return;localStorage.setItem('imgbbApiKey',k);savePhoto();return;}
    showLoading(true);
    try{
        const fd=new FormData();fd.append('image',capturedPhoto.split(',')[1]);
        const r=await fetch(`https://api.imgbb.com/1/upload?key=${key}`,{method:'POST',body:fd});
        const d=await r.json();if(!d.success)throw new Error('Upload mislukt');
        const url=d.data.url;
        await notionRequest(`/pages/${currentProduct.id}`,'PATCH',{properties:{'Afbeelding':{files:[{type:'external',name:'product.jpg',external:{url}}]}}});
        currentProduct.imageUrl=url;document.getElementById('productImage').innerHTML=`<img src="${url}">`;
        document.getElementById('photoPanel').style.display='none';capturedPhoto=null;showToast('Foto opgeslagen');
    }catch(e){showToast('Fout','error');}
    showLoading(false);
}

// === NEW ARTICLE ===
function scanForNewArticle(){showScreen('scan');}
function generateBarcode(){const c='DM'+Date.now().toString(36).toUpperCase()+Math.random().toString(36).substring(2,5).toUpperCase();newArticleBarcode=c;document.getElementById('newArticleBarcode').textContent=c;document.getElementById('newBarcodeInput').value=c;}
function updateNewBarcode(v){newArticleBarcode=v;document.getElementById('newArticleBarcode').textContent=v||'-';}

async function saveNewArticle(){
    const name=document.getElementById('newName').value.trim();
    const cat=document.getElementById('newCategory').value;
    const unit=document.getElementById('newUnit').value;
    if(!name||!cat||!unit||!newArticleBarcode){showToast('Vul verplichte velden in','error');return;}
    if(products.find(p=>p.barcode===newArticleBarcode)){showToast('Barcode bestaat al','error');return;}
    showLoading(true);
    try{
        const props={'OMSCHRIJVIN':{title:[{text:{content:name}}]},' ID (barcode)':{rich_text:[{text:{content:newArticleBarcode}}]},'HOOFDGROEP':{select:{name:cat}},'EENHEID':{select:{name:unit}},'TYPE ITEM':{select:{name:'STOCK'}}};
        const price=parseFloat(document.getElementById('newPrice').value)||0;
        const stock=parseInt(document.getElementById('newStock').value)||0;
        const supp=document.getElementById('newSupplier').value;
        if(price)props['AANKOOP PRIJS ']={number:price};
        if(stock)props['STOCK (begin 2023) manual overrule']={number:stock};
        if(supp)props['Leverancier']={select:{name:supp}};
        const res=await notionRequest('/pages','POST',{parent:{database_id:STOCK_DB},properties:props});
        const np={id:res.id,name,barcode:newArticleBarcode,category:cat,unit,price,stock,supplier:supp};
        products.push(np);products.sort((a,b)=>a.name.localeCompare(b.name));
        ['newName','newCategory','newUnit','newPrice','newStock','newSupplier','newBarcodeInput'].forEach(id=>document.getElementById(id).value='');
        newArticleBarcode='';document.getElementById('newArticleBarcode').textContent='-';
        showToast('Artikel aangemaakt!');selectProduct(np);
    }catch(e){showToast('Fout','error');}
    showLoading(false);
}

// === HISTORY & LOG ===
function addToHistory(item){history.unshift({...item,time:new Date().toISOString()});history=history.slice(0,50);localStorage.setItem('scan_history',JSON.stringify(history));renderHistory();updateStats();}
function renderHistory(){const list=document.getElementById('historyList');const today=new Date().toDateString();const h=history.filter(x=>new Date(x.time).toDateString()===today);if(!h.length){list.innerHTML='<div class="empty-state"><div class="empty-state-icon">üïê</div><div>Nog geen activiteit</div></div>';return;}list.innerHTML=h.slice(0,8).map(i=>`<div class="history-item"><div class="history-icon ${i.amount<0?'out':'in'}">${i.amount<0?'‚Üë':'‚Üì'}</div><div class="history-info"><div class="history-name">${esc(i.name)}</div><div class="history-details">${esc(i.project)} ‚Ä¢ ${new Date(i.time).toLocaleTimeString('nl-BE',{hour:'2-digit',minute:'2-digit'})}</div></div><div class="history-amount ${i.amount<0?'out':'in'}">${i.amount>0?'+':''}${i.amount}</div></div>`).join('');}

function addToScanLog(item){scanLog.unshift({...item,time:new Date().toISOString()});scanLog=scanLog.slice(0,500);localStorage.setItem('scan_log',JSON.stringify(scanLog));}

function renderLog(){
    const list=document.getElementById('logList');
    const byProj={};scanLog.forEach((e,idx)=>{
        if(!byProj[e.projectId])byProj[e.projectId]={id:e.projectId,name:e.projectName,number:e.projectNumber,items:[],totalCost:0,totalMargin:0};
        const m=marginOverrides[`${e.projectId}_${e.productId}`]??e.margin??0.2;
        const c=Math.abs(e.quantity)*(e.price||0);
        byProj[e.projectId].items.push({...e,margin:m,cost:c,withMargin:c*(1+m),logIndex:idx});
        byProj[e.projectId].totalCost+=c;
        byProj[e.projectId].totalMargin+=c*(1+m);
    });
    const pList=Object.values(byProj).sort((a,b)=>b.number-a.number);
    if(!pList.length){list.innerHTML='<div class="empty-state"><div class="empty-state-icon">üìä</div><div>Nog geen registraties</div></div>';return;}
    
    list.innerHTML=pList.map((proj,idx)=>{
        // Group items by date then product
        const itemsHtml=proj.items.map(i=>{
            const date=new Date(i.time).toLocaleDateString('nl-BE',{day:'2-digit',month:'2-digit'});
            const time=new Date(i.time).toLocaleTimeString('nl-BE',{hour:'2-digit',minute:'2-digit'});
            const c=Math.abs(i.quantity)*(i.price||0);
            const wm=c*(1+i.margin);
            const syncIcon=i.notionPageId?'‚òÅÔ∏è':'üíæ';
            const syncTitle=i.notionPageId?'Gesync met Notion':'Alleen lokaal opgeslagen';
            const qtyColor=i.quantity<0?'var(--accent)':'var(--success)';
            return `<div class="log-item" style="flex-wrap:wrap;gap:8px;padding:12px">
                <div style="flex:1;min-width:120px">
                    <div style="display:flex;align-items:center;gap:6px">
                        <span title="${syncTitle}" style="cursor:help;font-size:12px">${syncIcon}</span>
                        <span style="font-weight:600;font-size:14px">${esc(i.productName)}</span>
                    </div>
                    <div style="font-size:11px;color:var(--text-muted);margin-top:4px">${date} ${time} ‚Ä¢ ${i.user||'?'}</div>
                </div>
                <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
                    <div style="display:flex;align-items:center;background:var(--bg);border-radius:8px;border:1px solid var(--border)">
                        <button onclick="event.stopPropagation();adjustLogQty(${i.logIndex},-1)" style="width:36px;height:36px;border:none;background:none;color:var(--accent);font-size:18px;font-weight:bold;cursor:pointer;border-radius:8px 0 0 8px">‚àí</button>
                        <input type="number" value="${i.quantity}" onchange="updateLogQty(${i.logIndex},this.value)" onclick="event.stopPropagation()" style="width:50px;text-align:center;padding:6px 2px;border:none;border-left:1px solid var(--border);border-right:1px solid var(--border);background:transparent;color:${qtyColor};font-size:15px;font-weight:700;font-family:'JetBrains Mono',monospace">
                        <button onclick="event.stopPropagation();adjustLogQty(${i.logIndex},1)" style="width:36px;height:36px;border:none;background:none;color:var(--success);font-size:18px;font-weight:bold;cursor:pointer;border-radius:0 8px 8px 0">+</button>
                    </div>
                    <div style="text-align:right;min-width:60px">
                        <div style="font-size:11px;color:var(--text-muted)">‚Ç¨${c.toFixed(2)}</div>
                        <div style="font-size:13px;color:var(--success);font-weight:600">‚Ç¨${wm.toFixed(2)}</div>
                    </div>
                    <button onclick="event.stopPropagation();deleteLogItem(${i.logIndex})" style="width:40px;height:40px;display:flex;align-items:center;justify-content:center;background:var(--danger);color:#fff;border:none;border-radius:8px;font-size:16px;cursor:pointer" title="Verwijderen">üóëÔ∏è</button>
                </div>
            </div>`;
        }).join('');
        
        return `<div class="log-card">
            <div class="log-header" onclick="toggleLog(${idx})">
                <div class="log-info">
                    <div class="log-project">${proj.number} - ${esc(proj.name)}</div>
                    <div class="log-meta">${proj.items.length} registraties</div>
                </div>
                <div class="log-totals">
                    <div class="log-total-cost">‚Ç¨${proj.totalCost.toFixed(2)}</div>
                    <div class="log-total-margin">‚Ç¨${proj.totalMargin.toFixed(2)}</div>
                </div>
                <div class="log-chevron" id="logChevron${idx}">‚ñ∂</div>
            </div>
            <div class="log-details" id="logDetails${idx}">
                ${itemsHtml}
                <div style="display:flex;gap:10px;margin-top:16px;flex-wrap:wrap">
                    <button class="btn btn-secondary" onclick="syncMargins('${proj.id}')" style="flex:1;min-width:120px;padding:12px">‚òÅÔ∏è Sync Notion</button>
                    <button class="btn" onclick="deleteProjectLog('${proj.id}')" style="background:var(--danger);color:#fff;flex:1;min-width:120px;padding:12px;border:none;border-radius:10px;font-weight:600;cursor:pointer">üóëÔ∏è Alles wissen</button>
                </div>
            </div>
        </div>`;
    }).join('');
}

function adjustLogQty(idx,delta){
    const item=scanLog[idx];
    const newQty=item.quantity+delta;
    updateLogQty(idx,newQty);
}

async function updateLogQty(idx,val){
    const newQty=parseInt(val)||0;
    if(newQty===0){
        deleteLogItem(idx);
        return;
    }
    
    const item=scanLog[idx];
    const oldQty=item.quantity;
    
    // Update Notion if we have page ID
    if(item.notionPageId){
        showLoading(true);
        try{
            await notionRequest(`/pages/${item.notionPageId}`,'PATCH',{
                properties:{
                    'Aantal':{number:newQty}
                }
            });
            debugLog('Notion registratie aangepast',{pageId:item.notionPageId,oldQty,newQty});
        }catch(e){
            console.error('Notion update fout:',e);
            showToast('Notion sync mislukt','error');
            showLoading(false);
            return;
        }
        showLoading(false);
    }
    
    // Update local
    scanLog[idx].quantity=newQty;
    localStorage.setItem('scan_log',JSON.stringify(scanLog));
    renderLog();
    showToast(`Aantal: ${oldQty} ‚Üí ${newQty}`);
}

async function deleteLogItem(idx){
    if(!confirm('Registratie verwijderen?\nDit verwijdert ook de Notion registratie.'))return;
    
    const item=scanLog[idx];
    
    // Archive in Notion if we have page ID
    if(item.notionPageId){
        showLoading(true);
        try{
            await notionRequest(`/pages/${item.notionPageId}`,'PATCH',{
                archived:true
            });
            debugLog('Notion registratie gearchiveerd',{pageId:item.notionPageId});
        }catch(e){
            console.error('Notion delete fout:',e);
            // Continue anyway - maybe page was already deleted
        }
        showLoading(false);
    }
    
    // Update local
    scanLog.splice(idx,1);
    localStorage.setItem('scan_log',JSON.stringify(scanLog));
    renderLog();
    renderHistory();
    showToast('Registratie verwijderd');
}

async function deleteProjectLog(projId){
    const items=scanLog.filter(e=>e.projectId===projId);
    const count=items.length;
    const notionCount=items.filter(i=>i.notionPageId).length;
    
    if(!confirm(`Alle ${count} registraties voor dit project verwijderen?${notionCount>0?`\n\n${notionCount} Notion registraties worden gearchiveerd.`:''}`))return;
    
    // Archive in Notion
    if(notionCount>0){
        showLoading(true);
        for(const item of items){
            if(item.notionPageId){
                try{
                    await notionRequest(`/pages/${item.notionPageId}`,'PATCH',{archived:true});
                }catch(e){
                    console.error('Notion delete fout:',e);
                }
            }
        }
        showLoading(false);
    }
    
    // Update local
    scanLog=scanLog.filter(e=>e.projectId!==projId);
    localStorage.setItem('scan_log',JSON.stringify(scanLog));
    renderLog();
    renderHistory();
    showToast(`${count} registraties verwijderd`);
}

function toggleLog(idx){const d=document.getElementById('logDetails'+idx),c=document.getElementById('logChevron'+idx);const v=d.classList.toggle('visible');c.textContent=v?'‚ñº':'‚ñ∂';}
function updateMargin(key,val){marginOverrides[key]=Math.max(0,parseInt(val)||0)/100;localStorage.setItem('margin_overrides',JSON.stringify(marginOverrides));renderLog();}
async function syncMargins(projId){const upd=Object.entries(marginOverrides).filter(([k])=>k.startsWith(projId+'_')).map(([k,v])=>({productId:k.split('_')[1],margin:v}));if(!upd.length){showToast('Geen aangepaste marges');return;}if(!confirm(`${upd.length} marge(s) opslaan naar Notion?`))return;showLoading(true);for(const u of upd){try{await notionRequest(`/pages/${u.productId}`,'PATCH',{properties:{'MARGE / VERWERKINGSTOESLAG':{number:u.margin}}});}catch(e){}}showLoading(false);showToast('Marges opgeslagen');}
function clearScanLog(){if(!confirm('Scan log wissen?'))return;scanLog=[];localStorage.setItem('scan_log','[]');renderLog();}

// === CATEGORIES & FAVORITES ===
function renderCategoryPills(){document.getElementById('categoryPills').innerHTML=categories.map(c=>`<button class="filter-pill ${activeCategory===c.id?'active':''}" onclick="setCategory('${c.id}')">${c.icon} ${c.name}</button>`).join('');}
function setCategory(id){activeCategory=id;renderCategoryPills();filterProducts();}
function getCategoryIcon(cat){return categories.find(c=>c.id===cat)?.icon||'üì¶';}
function toggleCurrentFavorite(){if(!currentProduct)return;toggleFavorite(currentProduct.id);document.getElementById('productFavoriteBtn').textContent=favorites.includes(currentProduct.id)?'‚≠ê':'‚òÜ';}
function toggleFavorite(id){if(favorites.includes(id))favorites=favorites.filter(x=>x!==id);else favorites.push(id);localStorage.setItem('favorites',JSON.stringify(favorites));renderFavorites();}
function renderFavorites(){const card=document.getElementById('favoritesCard'),list=document.getElementById('favoritesList');const favs=products.filter(p=>favorites.includes(p.id));if(!favs.length){card.style.display='none';return;}card.style.display='block';list.innerHTML=favs.slice(0,5).map(p=>`<div class="product-item" onclick="selectProduct(products.find(x=>x.id==='${p.id}'))" style="padding:10px"><div class="product-icon" style="width:36px;height:36px;font-size:16px">${getCategoryIcon(p.category)}</div><div class="product-info"><div class="product-name">${esc(p.name)}</div></div><div class="product-stock ${(p.stock||0)<=1?'low':'ok'}">${p.stock||0}</div></div>`).join('');}

// === PROJECTS & USERS ===
function renderProjectSelect(){const sel=document.getElementById('projectSelect');sel.innerHTML=`<option value="">-- Project kiezen --</option><optgroup label="Actief">${activeProjects.map(p=>`<option value="${p.id}">${p.number} - ${esc(p.name)}</option>`).join('')}</optgroup><optgroup label="Archief">${archivedProjects.slice(0,20).map(p=>`<option value="${p.id}">${p.number} - ${esc(p.name)}</option>`).join('')}</optgroup>`;}
function renderUserSelect(){document.getElementById('userSelect').innerHTML=users.map(u=>`<option value="${u}" ${u===userName?'selected':''}>${u}</option>`).join('');}
function changeUser(name){userName=name;localStorage.setItem('user_name',name);document.getElementById('headerUser').textContent=name+' ‚ñº';}
function addUser(){const name=document.getElementById('newUserInput').value.trim();if(!name)return;if(!users.includes(name)){users.push(name);localStorage.setItem('users',JSON.stringify(users));renderUserSelect();}document.getElementById('newUserInput').value='';changeUser(name);}

// === SETTINGS ===
function saveApiKey(){const key=document.getElementById('settingsApiKey').value.trim();if(!key){showToast('Voer API key in','error');return;}testApiKey(key,false);}
function reloadData(){loadProducts();loadProjects();}
function clearAllData(){if(!confirm('Alle lokale data wissen?'))return;localStorage.clear();location.reload();}
function updateStats(){const today=new Date().toDateString();document.getElementById('statToday').textContent=history.filter(h=>new Date(h.time).toDateString()===today).length;document.getElementById('statTotal').textContent=products.length;}

// === MODALS & UTILS ===
function openModal(id){document.getElementById(id).classList.add('visible');}
function closeModal(id){document.getElementById(id).classList.remove('visible');}
function openOrderModal(){if(!currentProduct)return;document.getElementById('orderQuantity').value=Math.max(1,(currentProduct.idealStock||10)-(currentProduct.stock||0));document.getElementById('orderEmail').value=localStorage.getItem('order_email')||'';document.getElementById('orderNote').value='';document.getElementById('orderProductInfo').innerHTML=`<strong>${esc(currentProduct.name)}</strong><br>Leverancier: ${currentProduct.supplier||'-'}<br>Stock: ${currentProduct.stock||0}`;openModal('orderModal');}
function sendOrderEmail(){const qty=document.getElementById('orderQuantity').value,email=document.getElementById('orderEmail').value,note=document.getElementById('orderNote').value;localStorage.setItem('order_email',email);const subj=encodeURIComponent(`Bestelling: ${currentProduct.name}`),body=encodeURIComponent(`Product: ${currentProduct.name}\nAantal: ${qty} ${currentProduct.unit||'stuks'}\nLeverancier: ${currentProduct.supplier||'-'}\n\nStock: ${currentProduct.stock||0}\n${note?'\nOpmerking: '+note:''}\n\n${userName}`);window.open(`mailto:${email}?subject=${subj}&body=${body}`);closeModal('orderModal');}
function showLoading(show){document.getElementById('loadingOverlay').classList.toggle('visible',show);}
function showToast(msg,type='success'){const t=document.getElementById('toast');document.getElementById('toastIcon').textContent=type==='error'?'‚úï':'‚úì';document.getElementById('toastMessage').textContent=msg;t.classList.toggle('error',type==='error');t.classList.add('visible');setTimeout(()=>t.classList.remove('visible'),2500);}
function esc(str){return str?str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'):'';}

// === QR LABEL GENERATOR ===
let qrSelectedProducts=new Set();
let qrFilteredProducts=[];

function filterQRProducts(){
    const q=(document.getElementById('qrSearchInput')?.value||'').toLowerCase();
    const noCodeOnly=document.getElementById('qrFilterNoCode')?.checked||false;
    qrFilteredProducts=products.filter(p=>{
        const matchesSearch=!q||p.name?.toLowerCase().includes(q)||p.barcode?.toLowerCase().includes(q);
        // Filter op items zonder barcode als checkbox aangevinkt
        const hasNoCode=!p.barcode||p.barcode.trim()==='';
        const matchesNoCode=!noCodeOnly||hasNoCode;
        return matchesSearch&&matchesNoCode;
    });
    renderQRProductList();
}

function renderQRProductList(){
    const list=document.getElementById('qrProductList');
    if(!qrFilteredProducts.length)qrFilteredProducts=[...products];
    list.innerHTML=qrFilteredProducts.map(p=>{
        const hasBarcode=p.barcode&&p.barcode.trim()!=='';
        const hasDMCode=hasBarcode&&p.barcode.startsWith('DM-');
        let statusText, statusColor, statusIcon;
        
        if(hasDMCode){
            statusText=p.barcode;
            statusColor='var(--success)';
            statusIcon='‚úì';
        }else if(hasBarcode){
            statusText=p.barcode;
            statusColor='var(--warning)';
            statusIcon='üîó';
        }else{
            statusText='Geen code - wordt gegenereerd';
            statusColor='var(--accent)';
            statusIcon='‚ö†Ô∏è';
        }
        
        return `
        <div style="display:flex;align-items:center;padding:10px;border-bottom:1px solid var(--border);cursor:pointer" onclick="toggleQRSelect('${p.id}')">
            <div style="width:24px;height:24px;border:2px solid ${qrSelectedProducts.has(p.id)?'var(--success)':'var(--border)'};border-radius:6px;margin-right:12px;display:flex;align-items:center;justify-content:center;background:${qrSelectedProducts.has(p.id)?'var(--success)':'transparent'};color:#000;font-size:14px">${qrSelectedProducts.has(p.id)?'‚úì':''}</div>
            <div style="flex:1;min-width:0">
                <div style="font-size:13px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(p.name)}</div>
                <div style="font-size:11px;color:${statusColor};display:flex;align-items:center;gap:4px">
                    <span>${statusIcon}</span>
                    <span>${statusText}</span>
                </div>
            </div>
        </div>
    `;}).join('');
    updateQRCount();
}

function toggleQRSelect(id){
    if(qrSelectedProducts.has(id))qrSelectedProducts.delete(id);
    else qrSelectedProducts.add(id);
    renderQRProductList();
}

function selectAllQR(){
    qrFilteredProducts.forEach(p=>qrSelectedProducts.add(p.id));
    renderQRProductList();
}

function deselectAllQR(){
    qrSelectedProducts.clear();
    renderQRProductList();
}

function updateQRCount(){
    const selectedList=products.filter(p=>qrSelectedProducts.has(p.id));
    const withoutCode=selectedList.filter(p=>!p.barcode||p.barcode.trim()==='').length;
    let text=`${qrSelectedProducts.size} artikelen geselecteerd`;
    if(withoutCode>0){
        text+=` (${withoutCode} zonder code)`;
    }
    document.getElementById('qrSelectedCount').textContent=text;
}

function selectLabelFormat(format){
    // Update radio buttons
    document.querySelectorAll('input[name="labelFormat"]').forEach(r=>{
        r.checked=(r.value===format);
    });
    // Update visual styling
    ['square','small','medium'].forEach(f=>{
        const el=document.getElementById('labelFormat'+f.charAt(0).toUpperCase()+f.slice(1));
        if(el){
            el.style.borderColor=(f===format)?'var(--accent)':'var(--border)';
        }
    });
    debugLog('Label formaat geselecteerd',format);
}

async function getNextDMCode(){
    // Find highest existing DM code
    let maxNum=0;
    products.forEach(p=>{
        if(p.barcode&&p.barcode.startsWith('DM-')){
            const num=parseInt(p.barcode.replace('DM-',''),10);
            if(!isNaN(num)&&num>maxNum)maxNum=num;
        }
    });
    return maxNum+1;
}

async function generateQRLabels(){
    if(qrSelectedProducts.size===0){showToast('Selecteer eerst artikelen','error');return;}
    
    const format=document.querySelector('input[name="labelFormat"]:checked')?.value||'square';
    const saveToNotion=document.getElementById('qrSaveToNotion')?.checked||false;
    const selected=products.filter(p=>qrSelectedProducts.has(p.id));
    
    // Tel items zonder barcode
    const itemsWithoutCode=selected.filter(p=>!p.barcode||p.barcode.trim()==='');
    
    if(itemsWithoutCode.length>0&&saveToNotion){
        const proceed=confirm(`${itemsWithoutCode.length} artikel(en) hebben nog geen QR code.\n\nNieuwe DM-codes worden gegenereerd en opgeslagen in Notion.\n\nDoorgaan?`);
        if(!proceed)return;
    }
    
    showLoading(true);
    
    // Generate DM codes for products without one
    let nextCode=await getNextDMCode();
    const productsWithCodes=[];
    let savedCount=0;
    
    for(const p of selected){
        let code=p.barcode;
        
        // Generate new DM code only if product has NO barcode at all
        if(!code||code.trim()===''){
            code='DM-'+String(nextCode).padStart(4,'0');
            nextCode++;
            
            // Save to Notion if enabled
            if(saveToNotion){
                try{
                    debugLog('QR code opslaan in Notion',{id:p.id,name:p.name,code});
                    await notionRequest(`/pages/${p.id}`,'PATCH',{
                        properties:{' ID (barcode)':{rich_text:[{text:{content:code}}]}}
                    });
                    // Update local product
                    p.barcode=code;
                    const idx=products.findIndex(x=>x.id===p.id);
                    if(idx>=0)products[idx].barcode=code;
                    savedCount++;
                }catch(e){
                    debugLog('QR code opslaan mislukt',e.message);
                    showToast(`Fout bij ${p.name}`,'error');
                }
            }
        }
        
        productsWithCodes.push({...p,qrCode:code});
    }
    
    if(savedCount>0){
        showToast(`${savedCount} QR codes opgeslagen in Notion`);
    }
    
    showLoading(false);
    
    // Label dimensions based on format (Zebra ZD421 compatible)
    const labelConfigs={
        square:{w:'25mm',h:'25mm',qr:'20mm',nameSize:'6pt',codeSize:'5pt',layout:'column',nameMax:20},
        small:{w:'32mm',h:'25mm',qr:'20mm',nameSize:'6pt',codeSize:'5pt',layout:'row',nameMax:30},
        medium:{w:'51mm',h:'25mm',qr:'20mm',nameSize:'7pt',codeSize:'6pt',layout:'row',nameMax:50}
    };
    const cfg=labelConfigs[format]||labelConfigs.square;
    const isColumn=cfg.layout==='column';
    
    const printWindow=window.open('','_blank');
    printWindow.document.write(`
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>QR Labels - DM Stock (Zebra ZD421)</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"><\/script>
    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        @page{size:auto;margin:0}
        body{font-family:Arial,sans-serif;padding:2mm}
        .labels{display:flex;flex-wrap:wrap;gap:1mm}
        .label{
            width:${cfg.w};
            height:${cfg.h};
            border:0.3px dashed #ccc;
            padding:1mm;
            display:flex;
            align-items:center;
            ${isColumn?'flex-direction:column;justify-content:center;':''}
            page-break-inside:avoid;
            overflow:hidden;
            background:#fff;
        }
        .qr{
            width:${cfg.qr};
            height:${cfg.qr};
            flex-shrink:0;
            display:flex;
            align-items:center;
            justify-content:center;
        }
        .qr canvas{width:100%!important;height:100%!important}
        .info{
            ${isColumn?'text-align:center;margin-top:0.5mm;width:100%;':'flex:1;padding-left:1.5mm;'}
            overflow:hidden;
        }
        .name{
            font-size:${cfg.nameSize};
            font-weight:bold;
            line-height:1.1;
            overflow:hidden;
            text-overflow:ellipsis;
            ${isColumn?'white-space:nowrap;':'display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;'}
        }
        .code{
            font-size:${cfg.codeSize};
            color:#333;
            font-family:'Courier New',monospace;
            margin-top:0.3mm;
            letter-spacing:0.3px;
        }
        @media print{
            body{padding:0}
            .label{border:none}
            .no-print{display:none!important}
        }
        .no-print{
            position:fixed;
            top:0;
            left:0;
            right:0;
            background:#333;
            color:#fff;
            padding:15px 20px;
            display:flex;
            align-items:center;
            gap:15px;
            z-index:100;
        }
        .no-print button{
            padding:10px 20px;
            font-size:14px;
            cursor:pointer;
            border:none;
            border-radius:5px;
            background:#4CAF50;
            color:#fff;
            font-weight:bold;
        }
        .floating-print{
            position:fixed;
            bottom:20px;
            right:20px;
            padding:15px 30px;
            font-size:18px;
            background:#4CAF50;
            color:#fff;
            border:none;
            border-radius:10px;
            cursor:pointer;
            box-shadow:0 4px 15px rgba(0,0,0,0.3);
            z-index:101;
        }
    </style>
</head>
<body>
    <div class="no-print" style="position:relative">
        <strong>üñ®Ô∏è Zebra ZD421 - ${productsWithCodes.length} labels (${cfg.w} x ${cfg.h})</strong>
        <span style="font-size:12px;opacity:0.8;margin-left:10px">Stel printer in op juiste labelformaat</span>
    </div>
    <button class="floating-print no-print" onclick="window.print()">üñ®Ô∏è Printen</button>
    <div style="height:50px" class="no-print"></div>
    <div class="labels" id="labels"></div>
    <div style="height:80px" class="no-print"></div>
    <script>
        const products=${JSON.stringify(productsWithCodes)};
        const isColumn=${isColumn};
        const nameMax=${cfg.nameMax};
        const container=document.getElementById('labels');
        
        products.forEach((p,i)=>{
            const label=document.createElement('div');
            label.className='label';
            const shortName=p.name.length>nameMax?p.name.substring(0,nameMax-2)+'..':p.name;
            
            if(isColumn){
                label.innerHTML=\`
                    <div class="qr" id="qr\${i}"></div>
                    <div class="info">
                        <div class="name">\${shortName}</div>
                    </div>
                \`;
            }else{
                label.innerHTML=\`
                    <div class="qr" id="qr\${i}"></div>
                    <div class="info">
                        <div class="name">\${p.name}</div>
                        <div class="code">\${p.qrCode}</div>
                    </div>
                \`;
            }
            container.appendChild(label);
            
            QRCode.toCanvas(document.createElement('canvas'),p.qrCode,{width:200,margin:0},function(err,canvas){
                if(!err)document.getElementById('qr'+i).appendChild(canvas);
            });
        });
    <\/script>
</body>
</html>
    `);
    printWindow.document.close();
    
    showToast(`${productsWithCodes.length} labels gegenereerd`);
}

// Init QR products when screen opens
const origShowScreen=showScreen;
showScreen=function(screen){
    origShowScreen(screen);
    if(screen==='qrlabels'){
        qrFilteredProducts=[...products];
        renderQRProductList();
        // Reset to default format (square)
        selectLabelFormat('square');
    }
};

// Init debug mode from localStorage or URL param (?debug=1)
(function initDebug(){
    // Check URL param first
    const urlParams=new URLSearchParams(window.location.search);
    if(urlParams.get('debug')==='1'){
        localStorage.setItem('debug_mode','1');
    }
    
    debugMode=localStorage.getItem('debug_mode')==='1';
    if(debugMode){
        document.getElementById('debugToggle').checked=true;
        document.getElementById('debugConsole').style.display='block';
        document.getElementById('debugToggleKnob').style.left='27px';
        document.getElementById('debugToggleKnob').style.background='var(--success)';
        debugLog('App gestart, debug modus actief');
        debugLog('API Key aanwezig',{hasKey:!!apiKey,keyStart:apiKey?apiKey.substring(0,10)+'...':'geen'});
    }
})();

// Log errors globally
window.onerror=function(msg,url,line,col,error){
    debugLog('JS ERROR',{msg,line,col});
    console.error('Global error:',msg,line,col,error);
};

// === BLUETOOTH PRINTER (Niimbot B3S) ===
let bluetoothDevice=null;
let printerCharacteristic=null;
let printerConnected=false;

// Niimbot B3S UUIDs (gevonden via reverse engineering)
const NIIMBOT_SERVICE='e7810a71-73ae-499d-8c15-faa9aef0c3f2';
const NIIMBOT_CHAR_WRITE='bef8d6c9-9c21-4c9e-b632-bd58c1009f9f';
const NIIMBOT_CHAR_NOTIFY='bef8d6c9-9c21-4c9e-b632-bd58c1009f9f';

function updatePrinterStatus(connected,name=''){
    printerConnected=connected;
    const icon=document.getElementById('printerStatusIcon');
    const text=document.getElementById('printerStatusText');
    const sub=document.getElementById('printerStatusSub');
    const btn=document.getElementById('printerConnectBtn');
    const testBtn=document.getElementById('printerTestBtn');
    const niimbotBtn=document.getElementById('niimbotPrintBtn');
    
    if(connected){
        icon.textContent='üü¢';
        text.textContent=name||'Verbonden';
        sub.textContent='Printer klaar';
        btn.textContent='üîå Verbreek verbinding';
        btn.onclick=disconnectBluetoothPrinter;
        testBtn.style.display='block';
        if(niimbotBtn)niimbotBtn.style.opacity='1';
    }else{
        icon.textContent='‚ö™';
        text.textContent='Niet verbonden';
        sub.textContent='Klik om te verbinden';
        btn.textContent='üîó Verbind Printer';
        btn.onclick=connectBluetoothPrinter;
        testBtn.style.display='none';
        if(niimbotBtn)niimbotBtn.style.opacity='0.5';
    }
}

async function connectBluetoothPrinter(){
    if(!navigator.bluetooth){
        showToast('Bluetooth niet beschikbaar','error');
        alert('Web Bluetooth is niet beschikbaar in deze browser.\n\nGebruik Chrome op Android voor Bluetooth printen.');
        return;
    }
    
    debugLog('Zoeken naar Bluetooth printers...');
    showLoading(true);
    
    try{
        // Zoek naar Niimbot printers
        bluetoothDevice=await navigator.bluetooth.requestDevice({
            filters:[
                {namePrefix:'B3S'},
                {namePrefix:'Niimbot'},
                {namePrefix:'B21'},
                {namePrefix:'D11'},
                {namePrefix:'D110'}
            ],
            optionalServices:[NIIMBOT_SERVICE,'49535343-fe7d-4ae5-8fa9-9fafd205e455']
        });
        
        debugLog('Printer gevonden',{name:bluetoothDevice.name});
        
        bluetoothDevice.addEventListener('gattserverdisconnected',()=>{
            debugLog('Printer verbinding verbroken');
            updatePrinterStatus(false);
            showToast('Printer verbinding verbroken','error');
        });
        
        const server=await bluetoothDevice.gatt.connect();
        debugLog('GATT verbonden');
        
        // Zoek de juiste service
        let service;
        try{
            service=await server.getPrimaryService(NIIMBOT_SERVICE);
        }catch(e){
            // Probeer alternatieve service
            service=await server.getPrimaryService('49535343-fe7d-4ae5-8fa9-9fafd205e455');
        }
        debugLog('Service gevonden');
        
        // Zoek write characteristic
        const chars=await service.getCharacteristics();
        debugLog('Characteristics',chars.map(c=>c.uuid));
        
        // Neem de eerste writable characteristic
        for(const char of chars){
            if(char.properties.write||char.properties.writeWithoutResponse){
                printerCharacteristic=char;
                debugLog('Write characteristic gevonden',char.uuid);
                break;
            }
        }
        
        if(!printerCharacteristic){
            throw new Error('Geen write characteristic gevonden');
        }
        
        updatePrinterStatus(true,bluetoothDevice.name);
        showToast(`${bluetoothDevice.name} verbonden`);
        debugLog('Printer klaar');
        
    }catch(e){
        console.error('Bluetooth error:',e);
        debugLog('Bluetooth fout',e.message);
        if(e.message.includes('cancelled')){
            showToast('Verbinding geannuleerd');
        }else{
            showToast('Verbinding mislukt: '+e.message,'error');
        }
    }
    showLoading(false);
}

function disconnectBluetoothPrinter(){
    if(bluetoothDevice&&bluetoothDevice.gatt.connected){
        bluetoothDevice.gatt.disconnect();
    }
    bluetoothDevice=null;
    printerCharacteristic=null;
    updatePrinterStatus(false);
    showToast('Printer verbroken');
}

// Niimbot packet helpers
function niimbotPacket(type,data){
    const packet=new Uint8Array(data.length+6);
    packet[0]=0x55;  // Header 1
    packet[1]=0x55;  // Header 2
    packet[2]=type;  // Command type
    packet[3]=data.length; // Data length
    for(let i=0;i<data.length;i++){
        packet[4+i]=data[i];
    }
    // Checksum (XOR of type, length, and data)
    let checksum=type^data.length;
    for(let i=0;i<data.length;i++){
        checksum^=data[i];
    }
    packet[packet.length-2]=checksum;
    packet[packet.length-1]=0xAA; // Footer
    return packet;
}

async function sendToPrinter(data){
    if(!printerCharacteristic){
        throw new Error('Printer niet verbonden');
    }
    
    // Stuur in chunks van 20 bytes (BLE MTU limit)
    const chunkSize=20;
    for(let i=0;i<data.length;i+=chunkSize){
        const chunk=data.slice(i,Math.min(i+chunkSize,data.length));
        await printerCharacteristic.writeValue(chunk);
        await new Promise(r=>setTimeout(r,20)); // Kleine pauze tussen chunks
    }
}

async function testPrintLabel(){
    if(!printerConnected){
        showToast('Verbind eerst de printer','error');
        return;
    }
    
    showLoading(true);
    debugLog('Test print starten...');
    
    try{
        // Genereer een test QR code image
        const canvas=document.createElement('canvas');
        const ctx=canvas.getContext('2d');
        const size=240; // 30mm @ 203dpi = ~240 pixels
        canvas.width=size;
        canvas.height=size;
        
        // Witte achtergrond
        ctx.fillStyle='#ffffff';
        ctx.fillRect(0,0,size,size);
        
        // Genereer QR code
        const qr=generateQRMatrix('TEST-001');
        const cellSize=Math.floor(size/qr.length);
        const offset=Math.floor((size-cellSize*qr.length)/2);
        
        ctx.fillStyle='#000000';
        for(let y=0;y<qr.length;y++){
            for(let x=0;x<qr[y].length;x++){
                if(qr[y][x]){
                    ctx.fillRect(offset+x*cellSize,offset+y*cellSize,cellSize,cellSize);
                }
            }
        }
        
        // Omzetten naar printable formaat
        const imageData=ctx.getImageData(0,0,size,size);
        await printImageToNiimbot(imageData,size,size);
        
        showToast('Test label geprint!');
        debugLog('Test print voltooid');
        
    }catch(e){
        console.error('Print error:',e);
        debugLog('Print fout',e.message);
        showToast('Print mislukt: '+e.message,'error');
    }
    showLoading(false);
}

// QR code generator using qrcode-generator library
function generateQRMatrix(text){
    const qr=qrcode(0,'M'); // 0 = auto version, M = medium error correction
    qr.addData(text);
    qr.make();
    
    const size=qr.getModuleCount();
    const matrix=[];
    for(let y=0;y<size;y++){
        const row=[];
        for(let x=0;x<size;x++){
            row.push(qr.isDark(y,x)?1:0);
        }
        matrix.push(row);
    }
    return matrix;
}

// Genereer QR code als canvas
function generateQRCanvas(text,size=200){
    const qr=qrcode(0,'M');
    qr.addData(text);
    qr.make();
    
    const moduleCount=qr.getModuleCount();
    const cellSize=Math.floor(size/moduleCount);
    const actualSize=cellSize*moduleCount;
    
    const canvas=document.createElement('canvas');
    canvas.width=actualSize;
    canvas.height=actualSize;
    const ctx=canvas.getContext('2d');
    
    // Witte achtergrond
    ctx.fillStyle='#ffffff';
    ctx.fillRect(0,0,actualSize,actualSize);
    
    // Zwarte modules
    ctx.fillStyle='#000000';
    for(let y=0;y<moduleCount;y++){
        for(let x=0;x<moduleCount;x++){
            if(qr.isDark(y,x)){
                ctx.fillRect(x*cellSize,y*cellSize,cellSize,cellSize);
            }
        }
    }
    
    return canvas;
}

// Genereer QR code als data URL
function generateQRDataURL(text,size=200){
    const canvas=generateQRCanvas(text,size);
    return canvas.toDataURL('image/png');
}

async function printImageToNiimbot(imageData,width,height){
    // Omzetten naar 1-bit bitmap (zwart/wit)
    const rowBytes=Math.ceil(width/8);
    const bitmap=new Uint8Array(rowBytes*height);
    
    for(let y=0;y<height;y++){
        for(let x=0;x<width;x++){
            const idx=(y*width+x)*4;
            const gray=(imageData.data[idx]+imageData.data[idx+1]+imageData.data[idx+2])/3;
            if(gray<128){ // Zwart pixel
                const byteIdx=y*rowBytes+Math.floor(x/8);
                const bitIdx=7-(x%8);
                bitmap[byteIdx]|=(1<<bitIdx);
            }
        }
    }
    
    debugLog('Bitmap gegenereerd',{width,height,bytes:bitmap.length});
    
    // Stuur start print commando
    await sendToPrinter(niimbotPacket(0x01,[0x01])); // Start session
    await new Promise(r=>setTimeout(r,100));
    
    // Stuur label info (breedte/hoogte)
    const labelInfo=new Uint8Array([
        (width>>8)&0xFF,width&0xFF,
        (height>>8)&0xFF,height&0xFF
    ]);
    await sendToPrinter(niimbotPacket(0x13,labelInfo));
    await new Promise(r=>setTimeout(r,100));
    
    // Stuur bitmap data in chunks
    const chunkHeight=1; // 1 rij per keer
    for(let y=0;y<height;y+=chunkHeight){
        const rowData=bitmap.slice(y*rowBytes,(y+chunkHeight)*rowBytes);
        const packet=new Uint8Array(rowData.length+2);
        packet[0]=(y>>8)&0xFF;
        packet[1]=y&0xFF;
        packet.set(rowData,2);
        await sendToPrinter(niimbotPacket(0x85,packet));
        
        // Progress
        if(y%20===0){
            debugLog('Print progress',{row:y,total:height});
        }
    }
    
    // Stuur end print commando
    await sendToPrinter(niimbotPacket(0xF3,[0x01])); // Print & feed
    await new Promise(r=>setTimeout(r,500));
}

async function printToNiimbot(){
    if(!printerConnected){
        showToast('Verbind eerst de printer (Instellingen)','error');
        return;
    }
    
    if(qrSelectedProducts.size===0){
        showToast('Selecteer artikelen','error');
        return;
    }
    
    const saveToNotion=document.getElementById('qrSaveToNotion')?.checked||false;
    const selectedProducts=products.filter(p=>qrSelectedProducts.has(p.id));
    
    // Tel items zonder barcode
    const itemsWithoutCode=selectedProducts.filter(p=>!p.barcode||p.barcode.trim()==='');
    
    if(itemsWithoutCode.length>0&&saveToNotion){
        const proceed=confirm(`${itemsWithoutCode.length} artikel(en) hebben nog geen QR code.\n\nNieuwe DM-codes worden gegenereerd en opgeslagen in Notion.\n\nDoorgaan?`);
        if(!proceed){showLoading(false);return;}
    }
    
    const status=document.getElementById('niimbotPrintStatus');
    status.textContent=`Voorbereiden...`;
    showLoading(true);
    
    // Genereer QR codes voor items zonder
    let nextCode=await getNextDMCode();
    const productsWithCodes=[];
    let savedCount=0;
    
    for(const p of selectedProducts){
        let code=p.barcode;
        
        if(!code||code.trim()===''){
            code='DM-'+String(nextCode).padStart(4,'0');
            nextCode++;
            
            if(saveToNotion){
                try{
                    debugLog('QR code opslaan in Notion',{id:p.id,name:p.name,code});
                    await notionRequest(`/pages/${p.id}`,'PATCH',{
                        properties:{' ID (barcode)':{rich_text:[{text:{content:code}}]}}
                    });
                    p.barcode=code;
                    const idx=products.findIndex(x=>x.id===p.id);
                    if(idx>=0)products[idx].barcode=code;
                    savedCount++;
                }catch(e){
                    debugLog('QR code opslaan mislukt',e.message);
                }
            }
        }
        
        productsWithCodes.push({...p,qrCode:code});
    }
    
    if(savedCount>0){
        showToast(`${savedCount} QR codes opgeslagen in Notion`);
    }
    
    status.textContent=`Printen: 0/${productsWithCodes.length}...`;
    debugLog('Niimbot print starten',{count:productsWithCodes.length});
    
    try{
        for(let i=0;i<productsWithCodes.length;i++){
            const product=productsWithCodes[i];
            status.textContent=`Printen: ${i+1}/${productsWithCodes.length}...`;
            
            // Genereer label image
            const canvas=await generateLabelCanvas(product);
            const ctx=canvas.getContext('2d');
            const imageData=ctx.getImageData(0,0,canvas.width,canvas.height);
            
            // Print naar Niimbot
            await printImageToNiimbot(imageData,canvas.width,canvas.height);
            
            // Korte pauze tussen labels
            await new Promise(r=>setTimeout(r,300));
        }
        
        status.textContent=`‚úì ${productsWithCodes.length} labels geprint`;
        showToast(`${productsWithCodes.length} labels geprint!`);
        debugLog('Niimbot print voltooid');
        
    }catch(e){
        console.error('Print error:',e);
        debugLog('Print fout',e.message);
        status.textContent='Print mislukt: '+e.message;
        showToast('Print mislukt','error');
    }
    showLoading(false);
}

async function generateLabelCanvas(product){
    const format=document.querySelector('input[name="labelFormat"]:checked').value;
    
    // Formaten voor Niimbot B3S @ 203 DPI
    const formats={
        square:{w:200,h:200},  // ~25x25mm
        small:{w:320,h:240},   // ~40x30mm
        medium:{w:400,h:240}   // ~50x30mm
    };
    const size=formats[format]||formats.small;
    
    const canvas=document.createElement('canvas');
    canvas.width=size.w;
    canvas.height=size.h;
    const ctx=canvas.getContext('2d');
    
    // Witte achtergrond
    ctx.fillStyle='#ffffff';
    ctx.fillRect(0,0,size.w,size.h);
    
    // Bepaal barcode text (gebruik qrCode als beschikbaar, anders barcode)
    const barcodeText=product.qrCode||product.barcode||product.id.replace(/-/g,'').slice(0,12);
    
    // Genereer QR code
    const qrSize=format==='square'?160:140;
    const qr=generateQRMatrix(barcodeText);
    const cellSize=Math.floor(qrSize/qr.length);
    
    ctx.fillStyle='#000000';
    const qrX=format==='square'?(size.w-cellSize*qr.length)/2:10;
    const qrY=format==='square'?10:(size.h-cellSize*qr.length)/2;
    
    for(let y=0;y<qr.length;y++){
        for(let x=0;x<qr[y].length;x++){
            if(qr[y][x]){
                ctx.fillRect(qrX+x*cellSize,qrY+y*cellSize,cellSize,cellSize);
            }
        }
    }
    
    // Tekst toevoegen (niet bij vierkant formaat - te weinig ruimte)
    if(format!=='square'){
        ctx.font='bold 16px Arial';
        ctx.fillStyle='#000000';
        const textX=qrX+qrSize+10;
        const textMaxWidth=size.w-textX-10;
        
        // Product naam (kort)
        const name=product.name.length>20?product.name.substring(0,18)+'...':product.name;
        ctx.fillText(name,textX,30,textMaxWidth);
        
        // Barcode
        ctx.font='12px monospace';
        ctx.fillText(barcodeText,textX,50,textMaxWidth);
    }else{
        // Bij vierkant alleen barcode onder QR
        ctx.font='10px monospace';
        ctx.textAlign='center';
        ctx.fillText(barcodeText.slice(-8),size.w/2,size.h-10);
    }
    
    return canvas;
}

// Init printer status
updatePrinterStatus(false);
</script>
</body>
</html>
